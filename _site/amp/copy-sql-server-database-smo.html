<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Copy SQL Server Database with SQL Server Management Objects (SMO)</title>
    <link rel="canonical" href="https://www.geekytidbits.com/copy-sql-server-database-smo/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Jan 23, 2012</i>
      </span>
      <p>I recently came across the need the copy a SQL Server database structure and data to a new database.  I could use the <a href="http://msdn.microsoft.com/en-us/library/ms190436.aspx" target="_blank">Backup/Restore</a> method but I needed to be able to do this on an automated basis with ease.  I also needed the flexibility to change object names and generally have more control when creating the database copy.</p>

<p>Searching around, I found <a href="http://msdn.microsoft.com/en-us/library/ms162169.aspx" target="_blank">SQL Server Management Objects (SMO)</a> which are .NET assemblies that can be used to interact with SQL Server directly.  Actually, SQL Server Management Studio (SSMS) uses SMO under the hood for many operations such as the “Generate Scripts” screen.  SMO assemblies are installed in the folder C:\Program Files (x86)\Microsoft SQL Server\100\SDK\Assemblies\ when you select the “Client Tools SDK” during SQL Server install.  If you don’t have the assemblies installed and need help take a look at <a href="http://msdn.microsoft.com/en-us/library/ms162189.aspx" target="_blank">Installing SMO</a>.</p>

<p>Getting the SMO objects to do what I wanted was a bit tricky because the MSDN documentation isn’t so great and the the options can be confusing.  Some of the options are turned on by default (in a not so obvious way) and some options override other options.  Getting Full Text Search Index Catalogs to be scripted properly was not straight forward.  Also, when scripting the data, SMO won’t script it in the correct order to satisfy dependent primary keys (i.e. INSERT INTO State before INSERT INTO Address) unless you use something called a DependencyWalker.  Anyway, after some tweaking around I finally got SMO working like I wanted.</p>

<p>The first thing you need to do is add references to the following SMO assemblies:</p>

<ul>
  <li>C:\Program Files (x86)\Microsoft SQL Server\100\SDK\Assemblies\Microsoft.SqlServer.ConnectionInfo.dll</li>
  <li>C:\Program Files (x86)\Microsoft SQL Server\100\SDK\Assemblies\Microsoft.SqlServer.Management.Sdk.Sfc.dll</li>
  <li>C:\Program Files (x86)\Microsoft SQL Server\100\SDK\Assemblies\Microsoft.SqlServer.Smo.dll</li>
  <li>C:\Program Files (x86)\Microsoft SQL Server\100\SDK\Assemblies\Microsoft.SqlServer.SmoExtended.dll</li>
  <li>C:\Program Files (x86)\Microsoft SQL Server\100\SDK\Assemblies\Microsoft.SqlServer.SqlEnum.dll</li>
</ul>

<div>
  Here is the C# program I used to script out the database structure and data to .sql files, create the destination database, and run the scripts to build up the database copy.
</div>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">using</span> <span class="nn">System</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.SqlServer.Management.Smo</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">Microsoft.SqlServer.Management.Common</span><span class="p">;</span>
<span class="k">using</span> <span class="nn">System.IO</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Program</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">void</span> <span class="nf">Main</span><span class="p">(</span><span class="kt">string</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="kt">string</span> <span class="n">sourceServerName</span> <span class="p">=</span> <span class="s">"SOURCE_SERVER_NAME"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">sourceDatabaseName</span> <span class="p">=</span> <span class="s">"SourceDatabase"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">sourceUser</span> <span class="p">=</span> <span class="s">"sa"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">sourcePassword</span> <span class="p">=</span> <span class="s">"SuperSecretPassword"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">destinationServerName</span> <span class="p">=</span> <span class="s">"DESTINATION_SERVER_NAME"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">destinationDatabaseName</span> <span class="p">=</span> <span class="s">"NewDestinationDatabase"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">destinationUser</span> <span class="p">=</span> <span class="s">"sa"</span><span class="p">;</span>
        <span class="kt">string</span> <span class="n">destinationPassword</span> <span class="p">=</span> <span class="s">"SuperSecretPassword"</span><span class="p">;</span>

        <span class="n">Server</span> <span class="n">sourceServer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Server</span><span class="p">(</span><span class="k">new</span> <span class="nf">ServerConnection</span><span class="p">(</span><span class="n">sourceServerName</span><span class="p">,</span> <span class="n">sourceUser</span><span class="p">,</span> <span class="n">sourcePassword</span><span class="p">));</span>
        <span class="n">Server</span> <span class="n">destinationServer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Server</span><span class="p">(</span><span class="k">new</span> <span class="nf">ServerConnection</span><span class="p">(</span><span class="n">destinationServerName</span><span class="p">,</span> <span class="n">destinationUser</span><span class="p">,</span> <span class="n">destinationPassword</span><span class="p">));</span>
        <span class="n">Database</span> <span class="n">sourceDb</span> <span class="p">=</span> <span class="n">sourceServer</span><span class="p">.</span><span class="n">Databases</span><span class="p">[</span><span class="n">sourceDatabaseName</span><span class="p">];</span>
        <span class="n">Database</span> <span class="n">destinationDb</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Database</span><span class="p">(</span><span class="n">destinationServer</span><span class="p">,</span> <span class="n">destinationDatabaseName</span><span class="p">);</span>

        <span class="n">sourceServer</span><span class="p">.</span><span class="n">ConnectionContext</span><span class="p">.</span><span class="nf">Connect</span><span class="p">();</span>
        <span class="n">destinationServer</span><span class="p">.</span><span class="n">ConnectionContext</span><span class="p">.</span><span class="nf">Connect</span><span class="p">();</span>

        <span class="k">try</span>
        <span class="p">{</span>
            <span class="c1">//generate scripts</span>
            <span class="kt">string</span> <span class="n">structureScript</span> <span class="p">=</span> <span class="nf">ScriptStructure</span><span class="p">(</span><span class="n">sourceDb</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Concat</span><span class="p">(</span><span class="n">destinationDb</span><span class="p">,</span> <span class="s">"_Structure.sql"</span><span class="p">));</span>
            <span class="kt">string</span> <span class="n">dataScript</span> <span class="p">=</span> <span class="nf">ScriptData</span><span class="p">(</span><span class="n">sourceDb</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Concat</span><span class="p">(</span><span class="n">destinationDb</span><span class="p">,</span> <span class="s">"_Data.sql"</span><span class="p">));</span>

            <span class="n">destinationDb</span><span class="p">.</span><span class="nf">Create</span><span class="p">();</span>

            <span class="c1">//execute scripts in new database</span>
            <span class="n">destinationDb</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">(</span><span class="n">structureScript</span><span class="p">);</span>
            <span class="n">destinationDb</span><span class="p">.</span><span class="nf">ExecuteNonQuery</span><span class="p">(</span><span class="n">dataScript</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="k">finally</span>
        <span class="p">{</span>
            <span class="n">sourceServer</span><span class="p">.</span><span class="n">ConnectionContext</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">();</span>
            <span class="n">destinationServer</span><span class="p">.</span><span class="n">ConnectionContext</span><span class="p">.</span><span class="nf">Disconnect</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ScriptStructure</span><span class="p">(</span><span class="n">Database</span> <span class="n">sourceDb</span><span class="p">,</span> <span class="kt">string</span> <span class="n">destinationFileName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">Transfer</span> <span class="n">transfer</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Transfer</span><span class="p">(</span><span class="n">sourceDb</span><span class="p">);</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllObjects</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllFullTextCatalogs</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllFullTextStopLists</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllSynonyms</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllRules</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllDefaults</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllTables</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllStoredProcedures</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllViews</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllUserDefinedFunctions</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllUsers</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllDatabaseTriggers</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyAllUserDefinedTableTypes</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">CopyData</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ScriptingOptions</span><span class="p">();</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">WithDependencies</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ScriptingOptions</span><span class="p">();</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">ContinueScriptingOnError</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">FullTextCatalogs</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">FullTextStopLists</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">FullTextIndexes</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">DriAll</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">ExtendedProperties</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">Indexes</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">NonClusteredIndexes</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">Triggers</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">ToFileOnly</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">transfer</span><span class="p">.</span><span class="n">Options</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">destinationFileName</span><span class="p">;</span>

        <span class="n">transfer</span><span class="p">.</span><span class="nf">ScriptTransfer</span><span class="p">();</span>

        <span class="kt">string</span> <span class="n">script</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllText</span><span class="p">(</span><span class="n">destinationFileName</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">script</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">ScriptData</span><span class="p">(</span><span class="n">Database</span> <span class="n">sourceDb</span><span class="p">,</span> <span class="kt">string</span> <span class="n">destinationFileName</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">ScriptingOptions</span> <span class="n">scp</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">ScriptingOptions</span><span class="p">();</span>
        <span class="n">scp</span><span class="p">.</span><span class="n">ScriptSchema</span> <span class="p">=</span> <span class="k">false</span><span class="p">;</span>
        <span class="n">scp</span><span class="p">.</span><span class="n">ScriptData</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">scp</span><span class="p">.</span><span class="n">AppendToFile</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
        <span class="n">scp</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">destinationFileName</span><span class="p">;</span>
        <span class="n">scp</span><span class="p">.</span><span class="n">ToFileOnly</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>

        <span class="n">Scripter</span> <span class="n">scripter</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Scripter</span><span class="p">(</span><span class="n">sourceDb</span><span class="p">.</span><span class="n">Parent</span><span class="p">);</span>
        <span class="n">Table</span><span class="p">[]</span> <span class="n">tbls</span> <span class="p">=</span> <span class="k">new</span> <span class="n">Table</span><span class="p">[</span><span class="n">sourceDb</span><span class="p">.</span><span class="n">Tables</span><span class="p">.</span><span class="n">Count</span><span class="p">];</span>
        <span class="n">result</span><span class="p">.</span><span class="n">SourceDatabase</span><span class="p">.</span><span class="n">Tables</span><span class="p">.</span><span class="nf">CopyTo</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="m">0</span><span class="p">);</span>
        <span class="n">DependencyTree</span> <span class="n">tree</span> <span class="p">=</span> <span class="n">scripter</span><span class="p">.</span><span class="nf">DiscoverDependencies</span><span class="p">(</span><span class="n">tbls</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
        <span class="n">DependencyWalker</span> <span class="n">walker</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">DependencyWalker</span><span class="p">();</span>
        <span class="n">DependencyCollection</span> <span class="n">collection</span> <span class="p">=</span> <span class="n">walker</span><span class="p">.</span><span class="nf">WalkDependencies</span><span class="p">(</span><span class="n">tree</span><span class="p">);</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="n">DependencyCollectionNode</span> <span class="n">dep</span> <span class="k">in</span> <span class="n">collection</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">dep</span><span class="p">.</span><span class="n">Urn</span><span class="p">.</span><span class="nf">GetAttribute</span><span class="p">(</span><span class="s">"Name"</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sourceDb</span><span class="p">.</span><span class="n">Tables</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
                <span class="p">{</span>
                    <span class="n">Table</span> <span class="n">tbl</span> <span class="p">=</span> <span class="n">result</span><span class="p">.</span><span class="n">SourceDatabase</span><span class="p">.</span><span class="n">Tables</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
                    <span class="n">tbl</span><span class="p">.</span><span class="nf">EnumScript</span><span class="p">(</span><span class="n">scp</span><span class="p">);</span>
                <span class="p">}</span>
            <span class="p">}</span>

        <span class="kt">string</span> <span class="n">script</span> <span class="p">=</span> <span class="n">File</span><span class="p">.</span><span class="nf">ReadAllText</span><span class="p">(</span><span class="n">destinationFileName</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">script</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>