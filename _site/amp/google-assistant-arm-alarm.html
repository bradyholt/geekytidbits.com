<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Using Google Assistant to Arm my House Alarm</title>
    <link rel="canonical" href="https://www.geekytidbits.com/google-assistant-arm-alarm/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Mar 23, 2017</i>
      </span>
      <amp-youtube width="560" height="315" layout="responsive" data-videoid="V_INz5tQLGI">
  <a href="https://www.youtube.com/watch?v=V_INz5tQLGI"><amp-img src="https://img.youtube.com/vi/V_INz5tQLGI/0.jpg" width="480" height="360" layout="responsive"><noscript><img src="https://img.youtube.com/vi/V_INz5tQLGI/0.jpg" width="480" height="360"></noscript></amp-img></a>
</amp-youtube>

<p>I’ve had a <a href="https://madeby.google.com/home/">Google Home</a> up and running at the house for about two month and finally decided to create a Google Assistant Action for it. I already have <a href="https://github.com/bradymholt/vistaicm-server">vistaicm-server</a> running and connected to my Honeywell Vista 20P alarm panel so I thought I would create an Action so I could arm and disarm my house alarm system with my voice.</p>

<p>The <a href="https://developers.google.com/actions/">Actions Overview</a> points you to <a href="https://api.ai/">API.AI</a> because using it makes Action development very easy. I started building the Action out in the API.AI interface but I ran into 2 issues:</p>

<ul>
  <li>Once deployed for “Preview”, the Action is only available for 30 minutes. That wasn’t going to work. I ended up figuring out how to get around this (and <a href="http://stackoverflow.com/questions/41088596/make-google-actions-development-project-preview-persist-longer/41205026#41205026">posted the solution on StackOverflow</a>).</li>
  <li>API.AI abstracts some of the details of the <a href="https://developers.google.com/actions/reference/conversation">Conversation API</a> which was a bit frustrating sometimes because I wanted to learn it and have more control over it.</li>
</ul>

<p>Somewhere along the way I realized I didn’t need to go through API.AI and it would be a bit more of a learning experience to not do so. It turns out that writing the Action by hand is not terribly hard.</p>

<p>Below is what I learned and how I got it all setup.</p>

<h2 id="overview">Overview</h2>

<p>A Google Assistant Action has 2 main components:</p>

<ol>
  <li>Action Package - a JSON manifest that describes all the metadata about your action in addition to how users invoke and provide input to your action.</li>
  <li>Fulfillment - a service that you provide which conforms to the Conversation API](https://developers.google.com/actions/reference/conversation) and ultimately fulfills the user’s request.</li>
</ol>

<h3 id="action-package">Action Package</h3>

<p>The Action Package I ended up with is fairly simple.</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tiger"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"versionLabel"</span><span class="p">:</span><span class="w"> </span><span class="s2">"tiger"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"agentInfo"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"languageCode"</span><span class="p">:</span><span class="w"> </span><span class="s2">"en-US"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"projectId"</span><span class="p">:</span><span class="w"> </span><span class="s2">"08f738659b0b6368493346964c66bb01"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="s2">"actions"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"Default Welcome Intent"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"initialTrigger"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"intent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"assistant.intent.action.MAIN"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"queryPatterns"</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"httpExecution"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://[fulfillment_service_endpoint_url_here.com]"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"description"</span><span class="p">:</span><span class="w"> </span><span class="s2">"alarm"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"initialTrigger"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"intent"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ALARM"</span><span class="p">,</span><span class="w">
        </span><span class="s2">"queryPatterns"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="s2">"queryPattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"to $alarm-status:alarm-status"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="s2">"queryPattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"to $alarm-status:alarm-status the alarm"</span><span class="w"> </span><span class="p">},</span><span class="w">
            </span><span class="p">{</span><span class="w"> </span><span class="s2">"queryPattern"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$alarm-status:alarm-status the alarm"</span><span class="w"> </span><span class="p">}</span><span class="w">
          </span><span class="p">]</span><span class="w">
      </span><span class="p">},</span><span class="w">
      </span><span class="s2">"httpExecution"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s2">"url"</span><span class="p">:</span><span class="w"> </span><span class="s2">"https://[fulfillment_service_endpoint_url_here.com]"</span><span class="w"> </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="s2">"customTypes"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
      </span><span class="s2">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"$alarm-status"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"items"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
          </span><span class="p">{</span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"arm"</span><span class="p">,</span><span class="w"> </span><span class="s2">"synonyms"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"arm"</span><span class="p">]},</span><span class="w">
          </span><span class="p">{</span><span class="s2">"key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"disarm"</span><span class="p">,</span><span class="w"> </span><span class="s2">"synonyms"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"disarm"</span><span class="p">]}</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="p">[</span><span class="err">...</span><span class="p">]</span><span class="w">
</span></code></pre></div></div>

<p>Let’s break down the important parts:</p>

<ul>
  <li>
<strong>name</strong>: This is the name of the Action (“tiger”) but <em>does not</em> define the “invocation name” (keyword that Google Assistant uses to launch your Action). The invocation name is defined at the time the Action package is deployed.</li>
  <li>
<strong>intent</strong>: This defines the ID for the intent, used by the fulfillment endpoint to identify which action has been triggered.</li>
  <li>
<strong>queryPatterns</strong>: These are the speech patterns that Google Assistant will recognize.</li>
  <li>
<strong>httpExecution</strong>: This is the endpoint URI for the fulfillment service which implements the Conversation API.</li>
  <li>
<strong>customTypes</strong>: These are word variables (if you will) and allow you to define a list of words that can be used in a slot. You can reference a customType in your queryPatterns.</li>
</ul>

<p>With this setup, I can say any of the following:</p>

<ul>
  <li>Hey Google, tell tiger to arm (via the <code class="highlighter-rouge">to $alarm-status:alarm-status</code> queryPattern)</li>
  <li>Hey Google, tell tiger to arm the alarm (via the <code class="highlighter-rouge">to $alarm-status:alarm-status the alarm</code> queryPattern)</li>
  <li>Hey Google, tell tiger arm the alarm (via the <code class="highlighter-rouge">$alarm-status:alarm-status the alarm</code> queryPattern)</li>
</ul>

<h3 id="fulfillment">Fulfillment</h3>

<p>There is a npm package called <a href="https://www.npmjs.com/package/actions-on-google">actions-on-google</a> that is the client library for implementing the Conversation API in Node. This client makes it super easy to create a fulfillment service.</p>

<p>Here is what my service looks like:</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">ActionsSdkAssistant</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"actions-on-google"</span><span class="p">).</span><span class="nx">ActionsSdkAssistant</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">assistant</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ActionsSdkAssistant</span><span class="p">({</span>
  <span class="na">request</span><span class="p">:</span> <span class="nx">assistantRequest</span><span class="p">,</span>
  <span class="na">response</span><span class="p">:</span> <span class="nx">assistantResponse</span>
<span class="p">});</span>
<span class="kd">var</span> <span class="nx">actionMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Map</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">mainIntent</span><span class="p">(</span><span class="nx">assistant</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">assistant</span><span class="p">.</span><span class="nx">tell</span><span class="p">(</span>
    <span class="s2">"You can say something like tell tiger to arm the alarm or tell tiger to open the left garage door."</span>
  <span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">alarmIntent</span><span class="p">(</span><span class="nx">assistant</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">status</span> <span class="o">=</span> <span class="nx">assistant</span><span class="p">.</span><span class="nx">getArgument</span><span class="p">(</span><span class="s2">"alarm-status"</span><span class="p">);</span> <span class="c1">// alarm-status is a customType</span>
  <span class="kd">var</span> <span class="nx">tellSpeech</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">commandUrlPrefix</span> <span class="o">=</span> <span class="s2">"http://vistaicmHost:2945/execute?command="</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">commandUrl</span> <span class="o">=</span> <span class="s2">""</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">"arm"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">commandUrl</span> <span class="o">=</span> <span class="nx">commandUrlPrefix</span> <span class="o">+</span> <span class="s2">"arm"</span><span class="p">;</span>
    <span class="nx">tellSpeech</span> <span class="o">=</span> <span class="s2">"All secure!"</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">status</span> <span class="o">==</span> <span class="s2">"disarm"</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">commandUrl</span> <span class="o">=</span> <span class="nx">commandUrlPrefix</span> <span class="o">+</span> <span class="s2">"disarm"</span><span class="p">;</span>
    <span class="nx">tellSpeech</span> <span class="o">=</span> <span class="s2">"Disarmed!"</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">"GET "</span> <span class="o">+</span> <span class="nx">commandUrl</span><span class="p">);</span>
  <span class="nx">http</span>
    <span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">commandUrl</span><span class="p">,</span> <span class="nx">response</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">assistant</span><span class="p">.</span><span class="nx">tell</span><span class="p">(</span><span class="nx">tellSpeech</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"error"</span><span class="p">,</span> <span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`Error: </span><span class="p">${</span><span class="nx">e</span><span class="p">.</span><span class="nx">message</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span>
      <span class="nx">assistant</span><span class="p">.</span><span class="nx">tell</span><span class="p">(</span>
        <span class="s2">"Sorry, there was an error when trying to communicate with the house."</span>
      <span class="p">);</span>
    <span class="p">});</span>
<span class="p">}</span>

<span class="c1">// Action map: For each intent defined in the Action Package, define the handler for it.</span>
<span class="nx">actionMap</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="nx">assistant</span><span class="p">.</span><span class="nx">StandardIntents</span><span class="p">.</span><span class="nx">MAIN</span><span class="p">,</span> <span class="nx">mainIntent</span><span class="p">);</span>
<span class="nx">actionMap</span><span class="p">.</span><span class="kd">set</span><span class="p">(</span><span class="s2">"ALARM"</span><span class="p">,</span> <span class="nx">alarmIntent</span><span class="p">);</span>

<span class="nx">assistant</span><span class="p">.</span><span class="nx">handleRequest</span><span class="p">(</span><span class="nx">actionMap</span><span class="p">);</span>
</code></pre></div></div>

<h2 id="google-action-tiger">google-action-tiger</h2>

<p>After some refining, the final result is a project called <a href="https://github.com/bradymholt/google-action-tiger">google-action-tiger</a>. This project contains all the necessary parts for the Action: The action package, fulfillment code, and provisioning (i.e. “deploy”) script. I decided to host the fulfillment service on AWS Lambda because it is really suitable for this type of type of application, especially since HTTPS is baked in.</p>

<h2 id="usage">Usage</h2>

<p>In a gist, to get up and running all you need to do is:</p>

<ol>
  <li>Install <a href="https://github.com/bradymholt/google-action-tiger#dependencies">dependencies</a> per the README (including AWS and gactions CLI)</li>
  <li>Create an AWS Lambda function</li>
  <li>Create a config file, using config.example as a template</li>
  <li>Run <code class="highlighter-rouge">./deploy.sh</code>
</li>
</ol>

<p>The detailed instructions are located on the <a href="https://github.com/bradymholt/google-action-tiger/blob/master/README.md">README</a>.</p>

<p>I really like how everything is in a single repository and updates are deployed simply by running <code class="highlighter-rouge">./deploy</code>.</p>

<h3 id="deploysh">deploy.sh</h3>

<p>I decided to use a bash script for the <code class="highlighter-rouge">deploy.sh</code> (rather than node) script because the primary interaction is with the AWS and gactions CLI and doing that from node would have ended up just being a bunch of spawning of child processes. Wanting to use the <code class="highlighter-rouge">config</code> file for <em>all</em> config but also update the <code class="highlighter-rouge">actions.json</code> file with the <code class="highlighter-rouge">httpExecution.url</code> from <code class="highlighter-rouge">config</code> without creating a node script was a little tricky but I settled on passing straight JavsScript code to node using the <code class="highlighter-rouge">-e</code> parameter <a href="https://github.com/bradymholt/google-action-tiger/blob/master/deploy-google-assistant.sh#L10">here</a>. I am quite happy with how the <code class="highlighter-rouge">deploy.sh</code> file turned out.</p>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>