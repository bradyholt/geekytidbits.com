<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Google Calendar API from Ruby</title>
    <link rel="canonical" href="https://www.geekytidbits.com/google-calendar-api-from-ruby/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Mar 20, 2015</i>
      </span>
      <p>I have a Rails app that needs to sync events to a Google Calendar and I had been using the <a href="https://github.com/SeabourneConsulting/GCal4Ruby">gcal4ruby</a> gem to do this.  However, back in November 2014, Google deprecated the v1 and v2 Google Calendar API.  This gem does not use the newer v3 API so I had to make a change.</p>

<p>I decided to use the <a href="https://github.com/google/google-api-ruby-client">official Google API Client for Ruby</a>.  It took a bit of time to get up to speed with using this client, particularly because of the OAuth authentication requirement in v3 of the API.</p>

<p>The steps to get setup are:</p>

<ol>
  <li>Go to Google Developers Console – <a href="https://console.developers.google.com/project">https://console.developers.google.com/project</a>
</li>
  <li>Create a new Project</li>
  <li>Go to Project &gt; APIs &amp; Auth &gt; <strong>Credentials</strong>
</li>
  <li>Create <strong>New Client ID</strong> (OAuth).  Pay attention to the Authorized Redirect Uris; these are the Uris allowed to be redirected to when requesting authorization via OAuth.  This (or these) Uris should be a page you can receive a GET request on after OAuth authorization is given by a Google Account owner.</li>
  <li>Click <strong>Download JSON.  </strong>This will download a JSON file with all the app credentials (token / secret) needed to authenticate when connecting with the client.</li>
  <li>Rename the file downloaded above to <strong>client_secrets.json</strong> and move it to the same directory your app is running.</li>
</ol>

<p><a href="/media/google_developer_console.png"><amp-img src="/media/google_developer_console.png" alt="Google Developer Console" width="935" height="455" layout="responsive"><noscript><img src="/media/google_developer_console.png" alt="Google Developer Console" width="935" height="455"></noscript></amp-img></a></p>

<p>Once you create the app and get your client secrets file in place, you are ready to start using the client.  Here is some example Ruby code that demonstrates how to connect, authenticate, and perform basic Google Calendar API operations like querying for a list of events, adding, and updating.</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">#gem install 'google-api-client'</span>

<span class="nb">require</span> <span class="s1">'google/api_client'</span>

<span class="c1">#Setup auth client</span>
<span class="n">client_secrets</span> <span class="o">=</span> <span class="no">Google</span><span class="o">::</span><span class="no">APIClient</span><span class="o">::</span><span class="no">ClientSecrets</span><span class="p">.</span><span class="nf">load</span> <span class="c1">#client_secrets.json must be present in current directory!</span>
<span class="n">auth_client</span> <span class="o">=</span> <span class="n">client_secrets</span><span class="p">.</span><span class="nf">to_authorization</span>
<span class="n">auth_client</span><span class="p">.</span><span class="nf">update!</span><span class="p">(</span>
  <span class="ss">:scope</span> <span class="o">=&gt;</span> <span class="s1">'https://www.googleapis.com/auth/calendar'</span><span class="p">,</span>
  <span class="ss">:access_type</span> <span class="o">=&gt;</span> <span class="s2">"offline"</span><span class="p">,</span> <span class="c1">#will make refresh_token available</span>
  <span class="ss">:approval_prompt</span> <span class="o">=&gt;</span><span class="s1">'force'</span><span class="p">,</span>
  <span class="ss">:redirect_uri</span> <span class="o">=&gt;</span> <span class="s1">'http://www.myauthorizedredirecturl.com'</span>
<span class="p">)</span>

<span class="n">refresh_token_available</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">exist?</span><span class="p">(</span><span class="s1">'refresh_token.txt'</span><span class="p">)</span>

<span class="k">if</span> <span class="o">!</span><span class="n">refresh_token_available</span>
 <span class="c1">#OAuth URL - this is the url that will prompt a Google Account owner to give access to this app.</span>
 <span class="nb">puts</span> <span class="s2">"Navigate browser to: '</span><span class="si">#{</span><span class="n">auth_client</span><span class="p">.</span><span class="nf">authorization_uri</span><span class="p">.</span><span class="nf">to_s</span><span class="si">}</span><span class="s2">' and copy/paste auth code after redirect."</span>

 <span class="c1">#Once the authorization_uri (above) is followed and authorization is given, a redirect will be made</span>
 <span class="c1">#to http://www.myauthorizedredirecturl.com (defined above) and include the auth code in the request url.</span>
 <span class="nb">print</span> <span class="s2">"Auth code: "</span>
 <span class="n">auth_client</span><span class="p">.</span><span class="nf">code</span> <span class="o">=</span> <span class="nb">gets</span>
<span class="k">else</span>
 <span class="c1">#If authorization has already been given and refresh token saved previously, simply set the refresh code here.</span>
 <span class="n">auth_client</span><span class="p">.</span><span class="nf">refresh_token</span> <span class="o">=</span> <span class="no">File</span><span class="p">.</span><span class="nf">read</span><span class="p">(</span><span class="s1">'refresh_token.txt'</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">#Now, get our access token which is what we will need to work with the API.</span>
<span class="n">auth_client</span><span class="p">.</span><span class="nf">fetch_access_token!</span>

<span class="k">if</span> <span class="o">!</span><span class="n">refresh_token_available</span>
 <span class="c1">#Save refresh_token for next time</span>
 <span class="c1">#Note: auth_client.refresh_token is only available the first time after OAuth permission is granted.  </span>
 <span class="c1">#If you need it again, the Google Account owner would have deauthorize your app and you would have to request access again.</span>
 <span class="c1">#Therefore, it is important that the refresh token is saved after authenticating the first time!</span>
 <span class="no">File</span><span class="p">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'refresh_token.txt'</span><span class="p">,</span> <span class="s1">'w'</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span> <span class="n">file</span><span class="p">.</span><span class="nf">write</span><span class="p">(</span><span class="n">auth_client</span><span class="p">.</span><span class="nf">refresh_token</span><span class="p">)</span> <span class="p">}</span>
 <span class="n">refresh_token_available</span> <span class="o">=</span> <span class="kp">true</span>
<span class="k">end</span>

<span class="n">api_client</span> <span class="o">=</span> <span class="no">Google</span><span class="o">::</span><span class="no">APIClient</span><span class="p">.</span><span class="nf">new</span>
<span class="n">cal</span> <span class="o">=</span> <span class="n">api_client</span><span class="p">.</span><span class="nf">discovered_api</span><span class="p">(</span><span class="s1">'calendar'</span><span class="p">,</span> <span class="s1">'v3'</span><span class="p">)</span>

<span class="c1">#Get Event List</span>
<span class="nb">puts</span> <span class="s2">"Getting list of events..."</span>
<span class="n">list</span> <span class="o">=</span> <span class="n">api_client</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="ss">:api_method</span> <span class="o">=&gt;</span> <span class="n">cal</span><span class="p">.</span><span class="nf">events</span><span class="p">.</span><span class="nf">list</span><span class="p">,</span>
	<span class="ss">:authorization</span> <span class="o">=&gt;</span> <span class="n">auth_client</span><span class="p">,</span>
	<span class="ss">:parameters</span> <span class="o">=&gt;</span> <span class="p">{</span>
		<span class="s1">'maxResults'</span> <span class="o">=&gt;</span> <span class="mi">20</span><span class="p">,</span>
		<span class="s1">'timeMin'</span> <span class="o">=&gt;</span> <span class="s1">'2014-06-18T03:12:24-00:00'</span><span class="p">,</span>
		<span class="s1">'q'</span> <span class="o">=&gt;</span> <span class="s1">'Meeting'</span><span class="p">,</span>
		<span class="s1">'calendarId'</span> <span class="o">=&gt;</span> <span class="s1">'primary'</span><span class="p">})</span>

<span class="nb">puts</span> <span class="s2">"Fetched </span><span class="si">#{</span><span class="n">list</span><span class="p">.</span><span class="nf">data</span><span class="p">.</span><span class="nf">items</span><span class="p">.</span><span class="nf">count</span><span class="si">}</span><span class="s2"> events..."</span>

<span class="c1">#Update Event</span>
<span class="nb">puts</span> <span class="s2">"Updating first event from list..."</span>
<span class="n">update_event</span> <span class="o">=</span> <span class="n">list</span><span class="p">.</span><span class="nf">data</span><span class="p">.</span><span class="nf">items</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">update_event</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s2">"Updated Description here"</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">api_client</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="ss">:api_method</span> <span class="o">=&gt;</span> <span class="n">cal</span><span class="p">.</span><span class="nf">events</span><span class="p">.</span><span class="nf">update</span><span class="p">,</span>
	<span class="ss">:authorization</span> <span class="o">=&gt;</span> <span class="n">auth_client</span><span class="p">,</span>
	<span class="ss">:parameters</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'calendarId'</span> <span class="o">=&gt;</span> <span class="s1">'primary'</span><span class="p">,</span> <span class="s1">'eventId'</span> <span class="o">=&gt;</span> <span class="n">update_event</span><span class="p">.</span><span class="nf">id</span><span class="p">},</span>
	<span class="ss">:headers</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">},</span>
	<span class="ss">:body_object</span> <span class="o">=&gt;</span> <span class="n">update_event</span><span class="p">)</span>
<span class="nb">puts</span> <span class="s2">"Done with update."</span>

<span class="c1">#Add New Event</span>
<span class="nb">puts</span> <span class="s2">"Inserting new event..."</span>
<span class="n">new_event</span> <span class="o">=</span> <span class="n">cal</span><span class="p">.</span><span class="nf">events</span><span class="p">.</span><span class="nf">insert</span><span class="p">.</span><span class="nf">request_schema</span><span class="p">.</span><span class="nf">new</span>
<span class="n">new_event</span><span class="p">.</span><span class="nf">start</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'date'</span> <span class="o">=&gt;</span> <span class="s1">'2015-01-01'</span> <span class="p">}</span> <span class="c1">#All day event</span>
<span class="n">new_event</span><span class="p">.</span><span class="nf">end</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">'date'</span> <span class="o">=&gt;</span> <span class="s1">'2015-01-01'</span> <span class="p">}</span>
<span class="n">new_event</span><span class="p">.</span><span class="nf">description</span> <span class="o">=</span> <span class="s2">"Description here"</span>
<span class="n">new_event</span><span class="p">.</span><span class="nf">summary</span> <span class="o">=</span> <span class="s2">"Summary here"</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">api_client</span><span class="p">.</span><span class="nf">execute</span><span class="p">(</span><span class="ss">:api_method</span> <span class="o">=&gt;</span> <span class="n">cal</span><span class="p">.</span><span class="nf">events</span><span class="p">.</span><span class="nf">insert</span><span class="p">,</span>
	<span class="ss">:authorization</span> <span class="o">=&gt;</span> <span class="n">auth_client</span><span class="p">,</span>
	<span class="ss">:parameters</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s1">'calendarId'</span> <span class="o">=&gt;</span> <span class="s1">'primary'</span><span class="p">},</span>
	<span class="ss">:headers</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">'Content-Type'</span> <span class="o">=&gt;</span> <span class="s1">'application/json'</span><span class="p">},</span>
	<span class="ss">:body_object</span> <span class="o">=&gt;</span> <span class="n">new_event</span><span class="p">)</span>
<span class="nb">puts</span> <span class="s2">"Done with insert."</span>
</code></pre></div></div>


    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>