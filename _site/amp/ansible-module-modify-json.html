<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Ansible Module for Modifying JSON</title>
    <link rel="canonical" href="https://www.geekytidbits.com/ansible-module-modify-json/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Nov 16, 2015</i>
      </span>
      <p>I just recently finished a <a href="https://github.com/bradymholt/arena-sheets">side project in Node.js</a> and decided to use Ansible for provisioning a <a href="https://www.digitalocean.com/?refcode=974ef9a471c1">Digital Ocean</a> server
and deploying the app to it. As part of the deploy playbook, I needed a way to set production specific config values in a JSON file. There isn’t a native way to do this in Ansible
(that I know of at least) but I wrote a module to do it. It works great and I thought I would share it here.</p>

<p>Say you’ve got a JSON file like the following:</p>

<p><em>settings.json</em></p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"refresh_token"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="p">,</span><span class="w">
  </span><span class="s2">"password"</span><span class="p">:</span><span class="w"> </span><span class="s2">""</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>Drop the module file <a href="https://gist.github.com/bradymholt/17cb99185c7b80b0f34a">json_mod</a> in a folder name <code class="highlighter-rouge">/library</code> in your playbook directory and use it like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">update config values</span>
  <span class="na">json_mod</span><span class="pi">:</span>
    <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">settings.json"</span>
    <span class="na">refresh_token</span><span class="pi">:</span> <span class="s2">"</span><span class="s">AJDJKS839238AJKSJDKAD"</span>
    <span class="na">password</span><span class="pi">:</span> <span class="s2">"</span><span class="s">superSecurePassword"</span>
</code></pre></div></div>

<p>That’s it. The implementation is pretty simple and it only supports top level properties in the JSON file but I’d like to eventually improve it to support nested objects and array items
using <a href="http://stackoverflow.com/a/6491621/626911">this nify JavaScript function to access nested properties by key</a>.</p>

<p>Here’s the <em>json_mod</em> module. Enjoy!</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#!/usr/bin/env node
</span>
<span class="kd">var</span> <span class="nx">fs</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="s2">"utf8"</span><span class="p">);</span>
<span class="kd">var</span> <span class="nx">changed</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

<span class="kd">var</span> <span class="nx">jsonPath</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">json</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">keyValReplacementString</span> <span class="o">=</span> <span class="nx">args</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">" "</span><span class="p">);</span>
<span class="nx">keyValReplacementString</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">keyVal</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">"="</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">keyVal</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">return</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">keyVal</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">jsonPath</span> <span class="o">=</span> <span class="nx">stripQuotes</span><span class="p">(</span><span class="nx">keyVal</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
  <span class="p">}</span>
<span class="p">});</span>

<span class="k">if</span> <span class="p">(</span><span class="nx">jsonPath</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">json</span> <span class="o">=</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="nx">jsonPath</span><span class="p">,</span> <span class="s2">"utf8"</span><span class="p">));</span>

  <span class="nx">keyValReplacementString</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">keyVal</span> <span class="o">=</span> <span class="nx">i</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">"="</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">keyVal</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">indexOf</span><span class="p">(</span><span class="s2">"path"</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="nx">json</span><span class="p">[</span><span class="nx">keyVal</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="p">{</span>
      <span class="nx">json</span><span class="p">[</span><span class="nx">keyVal</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">stripQuotes</span><span class="p">(</span><span class="nx">keyVal</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="p">}</span>
  <span class="p">});</span>

  <span class="nx">fs</span><span class="p">.</span><span class="nx">writeFileSync</span><span class="p">(</span><span class="nx">jsonPath</span><span class="p">,</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">json</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>
  <span class="nx">changed</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">stripQuotes</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">text</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">[</span><span class="sr">"'</span><span class="se">]</span><span class="sr">*</span><span class="se">([^</span><span class="sr">'"</span><span class="se">]</span><span class="sr">+</span><span class="se">)[</span><span class="sr">'"</span><span class="se">]</span><span class="sr">*"/g</span><span class="p">,</span> <span class="s2">"$1"</span><span class="p">);</span>
<span class="p">}</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">changed</span><span class="p">:</span> <span class="nx">changed</span> <span class="p">}));</span>
</code></pre></div></div>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>