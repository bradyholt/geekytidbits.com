<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Rolling snapshots for EC2</title>
    <link rel="canonical" href="https://www.geekytidbits.com/rolling-snapshots-ec2/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Oct 26, 2012</i>
      </span>
      <p>One of the best things about EBS backed EC2 instances is the ability to create <a href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html" target="_blank">snapshots</a>.  To say this makes backing up your instances “easy” would be an understatement.  You can create these snapshots manually through the AWS Management Console and also using the <a href="http://docs.amazonwebservices.com/AWSEC2/latest/CommandLineReference/ApiReference-cmd-CreateSnapshot.html" target="_blank">ec2-create-snapshot</a> API command line tool.  The cost of these snapshots is just $0.125 per GB of data stored and incremental snapshots only store changed data so it’s really cheap to make lots of snapshots.</p>

<p>I wanted to be able to setup a daily cron job to automatically snapshot my EC2 instance so I wouldn’t have to worry about backups.  If I ever had a failure or data loss I could simply grab the automatically created snapshot from the previous day and restore it.  Running ec2-create-snapshop with cron is easy enough but there is a 500 count limit to snapshots and I really don’t want to keep hundreds of snapshots.  I really wanted to just keep a handful of ‘latest” snapshots.</p>

<p>Searching around I came cross a script that handled “rolling” snapshots which basically means it will create a snapshot and delete older ones to keep a specified number of latest snapshots.  This is exactly what I wanted.  The script I found was a bit outdated and needed some updates but I was able to make the needed changes fairly easily.  Here’s how you use it:</p>

<p><strong>Usage</strong>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ec2-create-rolling-snapshot <span class="o">[</span>OPTIONS] <span class="nt">-d</span> DESCRIPTION VOLUME MAX_SNAPSHOTS
</code></pre></div></div>

<p><strong>Example</strong> (keeps 7 most recent snapshots):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ec2-create-rolling-snapshot <span class="nt">-d</span> <span class="s2">"Daily backup-vol-fzz00z0z"</span> vol-fzz00z0z 7
</code></pre></div></div>

<p>This script depends on, and assumes the <a href="http://aws.amazon.com/developertools/351" target="_blank">Amazon EC2 API Tools</a> are installed.  If you are running Amazon Linux these should already be installed.  You’ll need to ensure the following environment variables are set and available at runtime.  If you are running from cron, remember, you’ll need to set these manually in your crontab or a wrapper script as environment variables set in your shell are not available at cron runtime.</p>

<ul>
  <li>AWS_ACCESS_KEY</li>
  <li>AWS_SECRET_KEY</li>
  <li>EC2_HOME</li>
  <li>JAVA_HOME</li>
</ul>

<p>Here’s the script:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c"># Rolling snapshots for ec2</span>
<span class="c"># Original version: 2010-05-28 by cwilper</span>
<span class="c"># Updated: 2012-10-25 by brady@geekytidbits.com</span>

<span class="c"># (Invoke with -h for more info)</span>

showHelp<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"SYNOPSIS"</span>
  <span class="nb">echo</span> <span class="s2">"   ec2-create-rolling-snapshot [OPTIONS] -d DESCRIPTION VOLUME MAX_SNAPSHOTS"</span>
  <span class="nb">echo</span> <span class="s2">"DESCRIPTION"</span>
  <span class="nb">echo</span> <span class="s2">"   Create a snapshot of a volume and delete the oldest snapshot"</span>
  <span class="nb">echo</span> <span class="s2">"   in the series, if necessary."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   The VOLUME parameter is the name of an existing volume."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   The DESCRIPTION parameter specifies the description to use for the"</span>
  <span class="nb">echo</span> <span class="s2">"   new snapshot. All snapshots in a series will have the same description."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   The MAX_SNAPSHOTS parameter specifies the maximum number of snapshots"</span>
  <span class="nb">echo</span> <span class="s2">"   in the series. If creation of the new snapshot exceeds this threshold,"</span>
  <span class="nb">echo</span> <span class="s2">"   the oldest snapshot in the series will be deleted."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"OPTIONS"</span>
  <span class="nb">echo</span> <span class="s2">"   Any option below may be passed a value of '-' to indicate that values"</span>
  <span class="nb">echo</span> <span class="s2">"   for that option should be read from stdin."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -O, --aws-access-key KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        AWS Access Key ID. Defaults to the value of the AWS_ACCESS_KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        environment variable (if set)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -W, --aws-secret-key KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        AWS Secret Access Key. Defaults to the value of the AWS_SECRET_KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        environment variable (if set)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -T, --security-token TOKEN"</span>
  <span class="nb">echo</span> <span class="s2">"        AWS delegation token. Defaults to the value of the AWS_DELEGATION_TOKEN"</span>
  <span class="nb">echo</span> <span class="s2">"        environment variable (if set)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -U, --url URL"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify URL as the web service URL to use. Defaults to the value of"</span>
  <span class="nb">echo</span> <span class="s2">"        'https://ec2.amazonaws.com' or to that of the EC2_URL environment"</span>
  <span class="nb">echo</span> <span class="s2">"        variable (if set). Overrides the default."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --region REGION"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify REGION as the web service region to use."</span>
  <span class="nb">echo</span> <span class="s2">"        This option will override the URL specified by the "</span><span class="nt">-U</span> URL<span class="s2">" option"</span>
  <span class="nb">echo</span> <span class="s2">"        and EC2_URL environment variable."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --dry-run"</span>
  <span class="nb">echo</span> <span class="s2">"        Don't create or delete any snapshots; just show what would be done."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -?, --help"</span>
  <span class="nb">echo</span> <span class="s2">"        Display this help."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --connection-timeout TIMEOUT"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify a connection timeout TIMEOUT (in seconds)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --request-timeout TIMEOUT"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify a request timeout TIMEOUT (in seconds)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
<span class="o">}</span>

<span class="k">while</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">]</span>
<span class="k">do
  case</span> <span class="nv">$1</span> <span class="k">in</span>
    <span class="nt">-h</span><span class="p">)</span>
      showHelp<span class="p">;</span>
      <span class="nb">exit </span>0<span class="p">;;</span>
    <span class="nt">--help</span><span class="p">)</span>
      showHelp<span class="p">;</span>
      <span class="nb">exit </span>0<span class="p">;;</span>
    -<span class="se">\?</span><span class="p">)</span>
      showHelp<span class="p">;</span>
      <span class="nb">exit </span>0<span class="p">;;</span>
    <span class="nt">--dry-run</span><span class="p">)</span>
      <span class="nv">dryrun</span><span class="o">=</span><span class="nb">true</span><span class="p">;;</span>
    <span class="nt">-d</span><span class="p">)</span>
      <span class="nv">description</span><span class="o">=</span><span class="nv">$2</span><span class="p">;</span>
      <span class="nv">volume</span><span class="o">=</span><span class="nv">$3</span>
      <span class="nv">max_snapshots</span><span class="o">=</span><span class="nv">$4</span><span class="p">;</span>
      <span class="nb">break</span><span class="p">;;</span>
    <span class="nt">--description</span><span class="p">)</span>
      <span class="nv">description</span><span class="o">=</span><span class="nv">$2</span><span class="p">;</span>
      <span class="nv">volume</span><span class="o">=</span><span class="nv">$3</span>
      <span class="nv">max_snapshots</span><span class="o">=</span><span class="nv">$4</span><span class="p">;</span>
      <span class="nb">break</span><span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
      <span class="nv">gen_opts</span><span class="o">=</span><span class="s2">"</span><span class="nv">$gen_opts</span><span class="s2"> </span><span class="nv">$1</span><span class="s2">"</span><span class="p">;;</span>
  <span class="k">esac</span>
  <span class="nb">shift</span><span class="p">;</span>
<span class="k">done

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$description</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Required parameter 'DESCRIPTION' missing (-h for usage)"</span>
  <span class="nb">exit </span>1
<span class="k">fi

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$volume</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Required parameter 'VOLUME' missing (-h for usage)"</span>
  <span class="nb">exit </span>1
<span class="k">fi

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$max_snapshots</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Required parameter 'MAX_SNAPSHOTS' missing (-h for usage)"</span>
  <span class="nb">exit </span>1
<span class="k">else
  if</span> <span class="o">[</span> <span class="nv">$max_snapshots</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>1
  <span class="k">fi
fi

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: The EC2_HOME environment variable is not defined."</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c">#if [ -z "$AWS_ACCESS_KEY" ]; then</span>
<span class="c">#  echo "ERROR: The AWS_ACCESS_KEY environment variable is not defined."</span>
<span class="c">#  exit 1</span>
<span class="c">#fi</span>

<span class="c">#if [ -z "$AWS_SECRET_KEY" ]; then</span>
<span class="c">#  echo "ERROR: The AWS_SECRET_KEY environment variable is not defined."</span>
<span class="c">#  exit 1</span>
<span class="c">#fi</span>

<span class="nv">tempfile</span><span class="o">=</span>/tmp/ec2-create-rolling-snapshot-<span class="nv">$$</span>.tmp

<span class="nv">ec2cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">/bin/ec2-create-snapshot</span><span class="nv">$gen_opts</span><span class="s2"> -d </span><span class="se">\"</span><span class="nv">$description</span><span class="se">\"</span><span class="s2"> </span><span class="nv">$volume</span><span class="s2">"</span>
<span class="nv">snapshot_id</span><span class="o">=</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$dryrun</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">eval</span> <span class="nv">$ec2cmd</span> <span class="o">&gt;</span> <span class="nv">$tempfile</span>
  <span class="nv">result</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span><span class="sb">`</span>
  <span class="nv">snapshot_id</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|grep SNAPSHOT|awk <span class="s1">'{print $2}'</span><span class="sb">`</span>
  <span class="nv">snapshot_state</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|grep SNAPSHOT|awk <span class="s1">'{print $4}'</span><span class="sb">`</span>
  <span class="nb">rm</span> <span class="nv">$tempfile</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$snapshot_id</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ERROR: Snapshot creation failed"</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
    <span class="nb">exit </span>1
  <span class="k">fi
  if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$snapshot_state</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"pending"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$snapshot_state</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"completed"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ERROR: Snapshot state is not pending or completed"</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
    <span class="nb">exit </span>1
  <span class="k">fi
  </span><span class="nb">echo</span> <span class="s2">"Created </span><span class="nv">$snapshot_id</span><span class="s2"> from </span><span class="nv">$volume</span><span class="s2">"</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"Created snap-TBD from </span><span class="nv">$volume</span><span class="s2"> (not really; this is a dry run)"</span>
<span class="k">fi

</span><span class="nv">ec2cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">/bin/ec2-describe-snapshots</span><span class="nv">$gen_opts</span><span class="s2">"</span>
<span class="nb">eval</span> <span class="nv">$ec2cmd</span> <span class="o">&gt;</span> <span class="nv">$tempfile</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$dryrun</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"SNAPSHOT snap-TBD </span><span class="nv">$volume</span><span class="s2"> pending 9999-99-99T99:99:99+9999 1 </span><span class="nv">$description</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> <span class="nv">$tempfile</span>
<span class="k">fi
</span><span class="nv">result</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span><span class="sb">`</span>
<span class="nv">series</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|grep SNAPSHOT|grep <span class="s2">"</span><span class="nv">$description</span><span class="s2">"</span>|grep <span class="nv">$volume</span>|awk <span class="s1">'{print $5,$2}'</span>|sort|awk <span class="s1">'{print $2}'</span><span class="sb">`</span>
<span class="nb">rm</span> <span class="nv">$tempfile</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$series</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: Failed to get snapshot series"</span>
  <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">count</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$series</span><span class="s2">"</span>|wc <span class="nt">-l</span>|awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"Series now contains </span><span class="nv">$count</span><span class="s2"> snapshots, max is </span><span class="nv">$max_snapshots</span><span class="s2">"</span>
<span class="nv">oldest</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$series</span><span class="s2">"</span>|head <span class="nt">-n</span> 1|awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$count</span> <span class="nt">-gt</span> <span class="nv">$max_snapshots</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$dryrun</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Deleting </span><span class="nv">$oldest</span><span class="s2">"</span>
    <span class="nv">ec2cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">/bin/ec2-delete-snapshot</span><span class="nv">$gen_opts</span><span class="s2"> </span><span class="nv">$oldest</span><span class="s2">"</span>
    <span class="nb">eval</span> <span class="nv">$ec2cmd</span> <span class="o">&gt;</span> <span class="nv">$tempfile</span>
    <span class="nv">result</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span><span class="sb">`</span>
    <span class="nv">check1</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
    <span class="nv">check2</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|awk <span class="s1">'{print $2}'</span><span class="sb">`</span>
    <span class="nb">rm</span> <span class="nv">$tempfile</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"SNAPSHOT"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check2</span><span class="s2">"</span> <span class="o">!=</span> <span class="nv">$oldest</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"ERROR: Unexpected output from ec2-delete-snapshot command"</span>
      <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
      <span class="nb">exit </span>1
    <span class="k">fi
  else
    </span><span class="nb">echo</span> <span class="s2">"Deleting </span><span class="nv">$oldest</span><span class="s2"> (not really; this is a dry run)"</span>
  <span class="k">fi
fi

</span><span class="nb">exit </span>0
</code></pre></div></div>

<p>For my own use, I wrapped this script in another script called from cron so I can set the needed environment variables and stop/start MySQL to ensure data integrity at time of snapshotting.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c">#Stop mysql to ensure snapshot consistancy</span>
<span class="nb">echo</span> <span class="s2">"Stopping mysql..."</span>
/sbin/service mysqld stop
<span class="nb">echo</span> <span class="s2">"Creating snapshot..."</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY</span><span class="o">=</span><span class="s2">"AKIDDDDDDDDDDDD"</span>
<span class="nb">export </span><span class="nv">AWS_SECRET_KEY</span><span class="o">=</span><span class="s2">"GQYL9/JKCFNbZ/2/DDDDDDDDDDDDDDDD"</span>
<span class="nb">export </span><span class="nv">EC2_HOME</span><span class="o">=</span>/opt/aws/apitools/ec2
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/jre
~/ec2-create-rolling-snapshot <span class="nt">-d</span> <span class="s2">"Daily backup-vol-fac00d0d"</span> vol-fac00d0d 7
<span class="nb">echo</span> <span class="s2">"Waiting for snapshot to finish building..."</span>
<span class="nb">sleep </span>10
<span class="nb">echo</span> <span class="s2">"Starting mysql..."</span>
/sbin/service mysqld start
</code></pre></div></div>

<p>I’ve had this setup and running for about 2 months now and it works great. I love a hands-off approach to backing up my server and the piece of mind knowing that I can easily grab and restore a snapshot from last night (or 3 days ago) with a few clicks.</p>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>