<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>How To Setup A Transparent Content Filtering Proxy</title>
    <link rel="canonical" href="https://www.geekytidbits.com/transparent-content-filtering-proxy/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Aug 10, 2011</i>
      </span>
      <p>To speed up web access and block obscene content on my home network, I setup a transparent content filtering proxy on my Arch Linux server with the help of <a href="http://www.squid-cache.org/" target="_blank">Squid </a>and <a href="http://dansguardian.org/" target="_blank">DansGuardian</a>.    Below are the steps I took to get it all working.</p>

<h3 id="install-and-configure-squid-web-proxy">Install and configure Squid (web proxy)</h3>

<p>Squid will act as our proxy server which should speed up our web browsing and allow the content filter (DansGuardian, explained below) to function as it requires one.</p>

<ul>
  <li>Run: <strong>pacman -S squid</strong> to install</li>
  <li>The default config file for squid is pretty much ready to go.  It’s a good thing because there are an overwhelming number of configuration options.  Anyway, keep the default config but add/change the following in your **/etc/squid/squid.conf **file.</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>acl localhost src 127.0.0.1/32
http_access allow localhost
http_access deny all
http_port 3128 transparent
dns_nameservers 208.67.222.123, 208.67.220.123 <span class="c">#OpenDNS FamilyShield DNS</span>
</code></pre></div></div>

<p><em>Note: The IP addresses specified for dns_nameservers are the <a href="http://www.opendns.com/landings/familyshield" target="_blank">OpenDNS FamilyShield</a> DNS servers.  This speeds up DNS lookups and provides a simple way to have an up-to-date blacklist for pornographic sites.  This will work in tandem with DansGuardian to filter web content.</em></p>

<ul>
  <li>Start Squid by running <strong>/etc/rc.d/squid start</strong>
</li>
</ul>

<h3 id="install-and-configure-dansguardian-content-filter">Install and configure DansGuardian (content filter)</h3>

<p>DansGuardian is the powerful, fast, open-source content filtering engine we will use.  It is very configurable but I will keep it simple for demonstration purposes.</p>

<ul>
  <li>Run: <strong>pacman -S dansguardian</strong> to install</li>
  <li>Make sure the following configuration options are set in your <strong>/etc/dansguardian/dansguardian.conf</strong> file</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>filterport <span class="o">=</span> 8888
proxyport <span class="o">=</span> 3128
</code></pre></div></div>

<ul>
  <li>Start DansGuardian by running <strong>/etc/rc.d/dansguradian start</strong>
</li>
</ul>

<h3 id="configure-your-router">Configure Your Router</h3>

<p>To make our solution truly *transparent *and avoid the need to configure each computer in our network individually, we need to make our router redirect outgoing web traffic to our proxy server that is running DansGuardian and Squid.  To do this, you’ll need a router running Linux (most do) and one that allows telnet or SSH access.  I have a Netgear router and after searching on the web found that if you navigate to the address: http://192.168.1.1/<strong>setup.cgi?todo=debug</strong> (192.168.1.1 being your router IP, of course), the router will allow telnet access on port 23, with the same credentials you use to login to the web interface.  Once you have connected, run the following command to redirect outgoing port 80 request:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-t</span> nat <span class="nt">-A</span> PREROUTING <span class="nt">-i</span> br0 <span class="nt">-s</span> <span class="o">!</span> 192.168.1.2 <span class="nt">-d</span> <span class="o">!</span> 192.168.1.2 <span class="nt">-p</span> tcp <span class="nt">--dport</span> 80 <span class="nt">-j</span> DNAT <span class="nt">--to</span> 192.168.1.2:8888
</code></pre></div></div>

<h3 id="notes">Notes</h3>

<ul>
  <li>192.168.1.2 is the IP address of our proxy server.  You’ll need to change this to match your own server’s address.</li>
  <li>It is likely that if you change anything through the web admin interface of your router, the iptables information will get overwritten.  You will need to re-run the above command if/when you make changes.  I actually setup a cron job that runs daily to reset the iptables configuration.  It first uses wget with http authentication to access the /setup.cgi?todo=debug page so that telnet access will be enabled and then issues remote telnet commands to configure iptables.  This is not necessary but makes for a more stable setup.</li>
  <li>To further ensure no machines are able to access the internet directly, I recommend configuring (through web admin interface) your router to block outgoing port 80 traffic from all IP addresses except the IP of your proxy server (192.158.1.2 in my case).  This is usually pretty easy to do and varies depending on the router you use. Remember, as mentioned above, you might need to re-run the iptables command after locking down outgoing traffic.</li>
</ul>

<h3 id="thats-it">That’s It!</h3>

<p>Now, if you browse to a website on a  client machine in your local network, it should send all the data through your  proxy server and provide content filtering.  There is no client configuration (i.e. proxy settings) needed as we have set things up in a transparent manner.</p>

<p>A good next step would be to read up on <a href="http://dansguardian.org/downloads/detailedinstallation2.html" target="_blank">configuring DansGuardian</a> and make it work to suite your needs.</p>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>