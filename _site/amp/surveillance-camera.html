<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Surveillance Camera</title>
    <link rel="canonical" href="https://www.geekytidbits.com/surveillance-camera/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Apr 6, 2012</i>
      </span>
      <p><a href="/media/400-20120405071852-00.jpg"><amp-img class="size-full wp-image-1019 alignright pull-right" title="400-20120405071852-00" alt="" src="/media/400-20120405071852-00.jpg" width="320" height="240" layout="responsive"><noscript><img class="size-full wp-image-1019 alignright pull-right" title="400-20120405071852-00" alt="" src="/media/400-20120405071852-00.jpg" width="320" height="240"></noscript></amp-img></a>Last year my house was burglarized.  I was away from home when it happened and got an iPhone <a href="http://www.prowlapp.com/" target="_blank">Prowl </a>notification from my <a href="/iphone-control-house-alarm-and-garage-doors/" target="_blank">AlarmServer app running on my Pogoplug</a> immediately after my alarm went off.  I called my next door neighbor, who was home at the time, and they went over right away but the thieves were already gone.  Based on alarm logs I know they were only in one part of the house and were in and out in <strong><em>less than 60 seconds</em></strong>.  Anyway, it was pretty cool getting the notification on my phone and being able to call my next door neighbor so soon after they broke in my door.  I have to assume my response time was faster than a paid monitoring service would be.</p>

<p>Although my alarm performed as it should have I realized that I needed video surveillance so I could identify the thieves to the police next time.  I decided to use a TRENDnet wireless IP netcam, my always on Linux server , and the open source program called Motion to accomplish said surveillance of my driveway and increase the security of my home.</p>

<h3 id="camera">Camera</h3>

<p><amp-img class="wp-image-1014 alignleft pull-left" title="TRENDnet ProView Wireless Internet Surveillance Camera TV-IP501W (White)" alt="" src="/media/41wrIM78PzL._SL500_AA300_.jpg" width="240" height="240" layout="responsive"><noscript><img class="wp-image-1014 alignleft pull-left" title="TRENDnet ProView Wireless Internet Surveillance Camera TV-IP501W (White)" alt="" src="/media/41wrIM78PzL._SL500_AA300_.jpg" width="240" height="240"></noscript></amp-img></p>

<p>The <a href="http://www.amazon.com/gp/product/B002Q0WO92/ref=oh_o04_s00_i00_details" target="_blank">TRENDnet ProView Wireless Internet Surveillance Camera TV-IP501W</a> (left) is a nice looking camera and mounted discreetly on the overhang of my roof.  It was easy to setup as all I needed to do was run a power cable to it.  It uses 802.11g so I didn’t need to worry about a separate ethernet cable.  It has a built in web server which is pretty easy to use.</p>

<h3 id="motion">Motion</h3>

<p>Although the TRENDnet camera has the ability to upload images to an FTP server, it doesn’t detect motion and drops many, too many,  images when configured to do so.  I decided to set up <a href="http://www.lavrsen.dk/foswiki/bin/view/Motion/WebHome" target="_blank">Motion</a>, “a software motion detector”, which intelligently detects motion and only saves images that show a material change in the picture.  The Motion website has a page with details on interfacing with TRENDnet camera which was helpful in getting everything configured: <a href="http://www.lavrsen.dk/foswiki/bin/view/Motion/TrendNet">http://www.lavrsen.dk/foswiki/bin/view/Motion/TrendNet</a>.  I installed Motion on my <a href="/my-pogoplug-geek-toy/" target="_blank">Pogoplug server</a> running Arch Linux by simply running <strong>pacman -S motion.</strong> The two important config settings in /etc/motion/motion.conf were:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>netcam_url http://192.168.1.7/VIDEO.CGI <span class="c">#192.168.1.7 is the IP address of the camera</span>
threshold 3000 <span class="c">#trial and error determined this to be best when camera is at 640x480 resolution</span>
</code></pre></div></div>

<h3 id="archiving">Archiving</h3>

<p>Motion does a great job of dropping only images that display motion but I wanted to have a bash script run nightly that would zip up all the images for the day and also create a time-lapse video so I could quickly see the motion for an entire day.  Also, I wanted it to only keep 10 days of history.  Here’s what I came up with:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c"># Format: YEAR MONTH DAY</span>
<span class="nv">DATE</span><span class="o">=</span><span class="k">$(</span><span class="nb">date</span> +%Y%m%d<span class="k">)</span>
<span class="nv">PATH</span><span class="o">=</span><span class="s2">"/srv/surveillance/driveway"</span>
<span class="nv">TARGET_FILE</span><span class="o">=</span><span class="s2">"</span><span class="nv">$PATH</span><span class="s2">/</span><span class="nv">$DATE</span><span class="s2">"</span>
<span class="nb">cd</span> <span class="nv">$PATH</span>

<span class="c">#create timelapse video</span>
/bin/rm <span class="nv">$TARGET_FILE</span>.mp4
<span class="nv">x</span><span class="o">=</span>1<span class="p">;</span> <span class="k">for </span>i <span class="k">in</span> <span class="k">$(</span>/bin/ls <span class="k">*</span>jpg<span class="k">)</span><span class="p">;</span> <span class="k">do </span><span class="nv">counter</span><span class="o">=</span><span class="k">$(</span><span class="nb">printf</span> %03d <span class="nv">$x</span><span class="k">)</span><span class="p">;</span> /bin/ln <span class="nt">-s</span> <span class="s2">"</span><span class="nv">$i</span><span class="s2">"</span> img<span class="s2">"</span><span class="nv">$count</span><span class="err">$</span><span class="s2">
/usr/bin/ffmpeg -r 5 -i img%03d.jpg -pix_fmt yuv420p </span><span class="nv">$TARGET_FILE</span><span class="s2">.mp4
/bin/rm img*.jpg

#archive images into zip
zip -m </span><span class="nv">$TARGET_FILE</span><span class="s2">.zip *.jpg -x </span><span class="se">\*</span><span class="s2">.zip

#remove image archives and videos that are at least 10 days old
find /srv/surveillance/driveway/* -mtime +10 -exec /bin/rm {} </span><span class="se">\;</span><span class="s2">
</span></code></pre></div></div>

<h3 id="iphone-integration">iPhone Integration</h3>

<p><a href="/media/photo3.png"><amp-img class="alignright" title="iphone alarm keypad with security camera image" alt="" src="/media/photo3.png" width="230" height="346" layout="responsive"><noscript><img class="alignright" title="iphone alarm keypad with security camera image" alt="" src="/media/photo3.png" width="230" height="346"></noscript></amp-img></a>In <a href="/iphone-control-house-alarm-and-garage-doors/" target="_blank">another project last year</a>, I wrote several components to monitor my alarm system.  One of the components was something I called AlarmWeb which is basically a HTML5 application that displays nicely on the iPhone (and Andriod for that matter).  After setting up the surveillance camera I decided it would be nice to integrate it with this interface.  I simply included &lt;a href=”http://192.168.1.7/VIDEO.CGI”&gt;&lt;img src=”http://192.168.1.7/IMAGE.JPG”/&gt;&lt;/a&gt; on the page so that an image still will show (IMAGE.JPG) and then clicking the image will take me to the live video feed (VIDEO.CGI) directly from the camera.</p>

<p><a href="/media/photo3.png"><br>
</a></p>

<h3 id="samples">Samples</h3>

<p>Single image</p>

<p><a href="/media/586-20120406080742-00.jpg"><amp-img class="alignnone size-full wp-image-1045" title="586-20120406080742-00" alt="" src="/media/586-20120406080742-00.jpg" width="320" height="240" layout="responsive"><noscript><img class="alignnone size-full wp-image-1045" title="586-20120406080742-00" alt="" src="/media/586-20120406080742-00.jpg" width="320" height="240"></noscript></amp-img></a></p>

<p>Time-lapse video</p>

<amp-video class="wp-video-shortcode" id="video-1013-2" width="640" height="360" poster="/media/surveillance_demo_poster.jpg" preload="metadata" controls="controls" layout="responsive"><source type="video/mp4" src="/media/surveillance_demo.mp4?_=2"></source><a href="/media/surveillance_demo.mp4">/media/surveillance_demo.mp4</a><div placeholder="placeholder">Loading...</div></amp-video>


    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>