<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Efficient Client-side Caching of Dynamic Resource Handlers in ASP.NET</title>
    <link rel="canonical" href="https://www.geekytidbits.com/efficient-caching-dynamic-resources-asp-net-304-not-modified/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Jun 18, 2012</i>
      </span>
      <h3 id="problem"><strong>Problem</strong></h3>

<p>You have some type of dynamic resource, like an image, you are serving up with an IHttpHandler (.ashx page) in ASP.NET.  You want the client browser to cache the resource locally but also be able to know when it has been updated server-side so it can fetch the latest version.</p>

<h3 id="options"><strong>Options</strong></h3>

<p>You could add the following lines to tell the client to cache the resource for only 1 hour and then after that ask the server for the latest version:</p>

<h4 id="limited-duration-cache">Limited Duration Cache</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetCacheability</span><span class="p">(</span><span class="n">HttpCacheability</span><span class="p">.</span><span class="n">Public</span><span class="p">);</span>
<span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetExpires</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">AddHours</span><span class="p">(</span><span class="m">1</span><span class="p">));</span>
</code></pre></div></div>

<p>But what if you want clients to fetch the latest after a change has been made rather than waiting an hour?  For instance, if you are serving a logo or thumbnail that must be up-to-date on the client.  In my particular case, I have a web application that has different “branding”, including a company logo, depending on the current Url.  When I am setting up a new brand or changing the logo on an existing brand I want clients to know they need to get the latest and greatest right away.  So, another option to accomplish this would be to tell the client to not cache the resource at all, and fetch the latest from the server every time it needs it:</p>

<h4 id="no-cache">No Cache</h4>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetCacheability</span><span class="p">(</span><span class="n">HttpCacheability</span><span class="p">.</span><span class="n">NoCache</span><span class="p">);</span>
</code></pre></div></div>

<p>But, come on.  That’s not efficient and is just silly.</p>

<h3 id="a-better-approach--304-not-modified"> A Better Approach – 304 Not Modified</h3>

<p>ASP.NET has some good tools for server-side caching (data cache, output cache, static variables, etc.) but when it comes to fine-tune controlling the HTTP  response headers the client uses to determine how to cache a resource client-side, things get <em>confusing</em> fast.</p>

<p>Anyway, a better way to approach this is to respond to the client’s initial request for the resource with the following HTTP headers:</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Cache-Control:public, must-revalidate, max-age=0
Last-Modified:Sun, 10 Jun 2012 20:19:21 GMT
</code></pre></div></div>

<p>This tells the browser to cache the resource but ask the server each time it needs to use it if it has changed. When it asks the server if it has changed, it will take the date specified in the Last-Modified header and send it to the server. Basically, the client will say to the server “Hey, I have a resource you previously gave me, dated “Sun, 10 Jun 2012 20:19:21 GMT”; is there a newer version available? If so send it to me. If not, just tell me there is not a newer version and I will use my locally cached copy. Thanks, have a good day.” If the server knows the resource has changed since the Last-Modified date it will send the newer copy to the client, just as it did initially. If it has not changed, it will respond with a simple “304 Not Modified” HTTP response, and not include the resource data in the response. This 304 response is extremely small in size so it should return very quickly.</p>

<p>This approach has the advantage that it still lets the client leverage its cache for performance gains but leaves the server in control of whether or not the client should show a newer version.</p>

<h4 id="a-working-example">A Working Example</h4>

<p>Below is a full-blown ASP.NET working example that demonstrates how to write the correct headers and respond with a 304 Not Modified response. Note: ImageContainer shown below is an arbitrary type containing an image I defined elsewhere in my own solution. In your case, you might be storing your image in a different way but the only thing that matters is being able to determine a timestamp (UpdatedAtUTC property in my case) so you know if the image has changed. If, for example, you are using handling an image stored on the server filesystem you might use something like File.GetLastWriteTime(@”c:\images\myimage.png”) to get the timestamp.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">MyImageResourceHandler</span> <span class="p">:</span> <span class="n">IHttpHandler</span><span class="p">,</span> <span class="n">IReadOnlySessionState</span>
<span class="p">{</span>
 <span class="k">public</span> <span class="k">void</span> <span class="nf">ProcessRequest</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
 <span class="p">{</span>
  <span class="c1">//ImageContainer is an arbitrary type that contains image data</span>
  <span class="n">ImageContainer</span> <span class="n">myImage</span> <span class="p">=</span> <span class="p">(</span><span class="n">ImageContainer</span><span class="p">)</span><span class="n">context</span><span class="p">.</span><span class="n">Session</span><span class="p">[</span><span class="s">"myImage"</span><span class="p">];</span>
  <span class="n">DateTime</span><span class="p">?</span> <span class="n">ifModifiedSinceTime</span> <span class="p">=</span> <span class="nf">GetIfModifiedSinceUTCTime</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>
  <span class="n">DateTime</span> <span class="n">imageLastModifiedTime</span> <span class="p">=</span> <span class="n">myImage</span><span class="p">.</span><span class="n">UpdatedAtUTC</span>
  <span class="c1">//strip milliseconds before comparison</span>
  <span class="n">imageLastModifiedTime</span> <span class="p">=</span> <span class="n">imageLastModifiedTime</span><span class="p">.</span><span class="nf">AddMilliseconds</span><span class="p">(-</span><span class="n">myImage</span><span class="p">.</span><span class="n">UpdatedAtUTC</span><span class="p">);</span>
  <span class="kt">bool</span> <span class="n">clientNeedsLatest</span> <span class="p">=</span> <span class="n">ifModifiedSinceTime</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="p">(</span><span class="n">imageLastModifiedTime</span> <span class="p">&amp;</span><span class="n">gt</span><span class="p">;</span> <span class="n">ifModifiedSinceTime</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(</span><span class="n">clientNeedsLatest</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">//write latest image to response</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">BinaryWrite</span><span class="p">(</span><span class="n">myImage</span><span class="p">.</span><span class="n">ImageBinary</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">ContentType</span> <span class="p">=</span> <span class="n">myImage</span><span class="p">.</span><span class="n">MimeType</span><span class="p">;</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">AddHeader</span><span class="p">(</span><span class="s">"content-disposition"</span><span class="p">,</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Concat</span><span class="p">(</span><span class="s">"inline; filename="</span><span class="p">,</span> <span class="n">myImage</span><span class="p">.</span><span class="n">FileNam</span>

    <span class="c1">//tell client to cache</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetCacheability</span><span class="p">(</span><span class="n">HttpCacheability</span><span class="p">.</span><span class="n">Private</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetRevalidation</span><span class="p">(</span><span class="n">HttpCacheRevalidation</span><span class="p">.</span><span class="n">AllCaches</span><span class="p">);</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetLastModified</span><span class="p">(</span><span class="n">imageLastModifiedTime</span><span class="p">);</span>

    <span class="c1">//set age/expires so that client doesn't attempt to use cache</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetMaxAge</span><span class="p">(</span><span class="k">new</span> <span class="nf">TimeSpan</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="m">0</span><span class="p">));</span> <span class="c1">//max-age=0</span>
    <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">Cache</span><span class="p">.</span><span class="nf">SetExpires</span><span class="p">(</span><span class="n">DateTime</span><span class="p">.</span><span class="n">Now</span><span class="p">.</span><span class="nf">ToUniversalTime</span><span class="p">());</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="p">{</span>
    <span class="c1">//tell the client the image has not changed!</span>
     <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="nf">ClearContent</span><span class="p">();</span>
     <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">StatusCode</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">System</span><span class="p">.</span><span class="n">Net</span><span class="p">.</span><span class="n">HttpStatusCode</span><span class="p">.</span><span class="n">NotModified</span><span class="p">;</span>
     <span class="n">context</span><span class="p">.</span><span class="n">Response</span><span class="p">.</span><span class="n">SuppressContent</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>
 <span class="p">}</span>

 <span class="k">private</span> <span class="n">DateTime</span><span class="p">?</span> <span class="nf">GetIfModifiedSinceUTCTime</span><span class="p">(</span><span class="n">HttpContext</span> <span class="n">context</span><span class="p">)</span>
 <span class="p">{</span>
  <span class="n">DateTime</span><span class="p">?</span> <span class="n">ifModifiedSinceTime</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>
  <span class="kt">string</span> <span class="n">ifModifiedSinceHeaderText</span> <span class="p">=</span> <span class="n">context</span><span class="p">.</span><span class="n">Request</span><span class="p">.</span><span class="n">Headers</span><span class="p">.</span><span class="nf">Get</span><span class="p">(</span><span class="s">"If-Modified-Since"</span><span class="p">);</span>

  <span class="k">if</span> <span class="p">(!</span><span class="kt">string</span><span class="p">.</span><span class="nf">IsNullOrEmpty</span><span class="p">(</span><span class="n">ifModifiedSinceHeaderText</span><span class="p">))</span>
  <span class="p">{</span>
    <span class="n">ifModifiedSinceTime</span> <span class="p">=</span> <span class="n">DateTime</span><span class="p">.</span><span class="nf">Parse</span><span class="p">(</span><span class="n">ifModifiedSinceHeaderText</span><span class="p">);</span>
   <span class="c1">//DateTime.Parse will return localized time but we want UTC</span>
   <span class="n">ifModifiedSinceTime</span> <span class="p">=</span> <span class="n">ifModifiedSinceTime</span> <span class="p">.</span><span class="n">Value</span><span class="p">.</span><span class="nf">ToUniversalTime</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="n">ifModifiedSinceTime</span><span class="p">;</span>
 <span class="p">}</span>

 <span class="k">public</span> <span class="kt">bool</span> <span class="n">IsReusable</span> <span class="p">{</span> <span class="k">get</span> <span class="p">{</span> <span class="k">return</span> <span class="k">false</span><span class="p">;</span> <span class="p">}</span> <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>