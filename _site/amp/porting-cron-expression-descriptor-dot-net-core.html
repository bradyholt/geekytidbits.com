<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Porting Cron Expression Descriptor to .NET Core</title>
    <link rel="canonical" href="https://www.geekytidbits.com/porting-cron-expression-descriptor-dot-net-core/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Aug 18, 2017</i>
      </span>
      <p>Last year, an <a href="https://github.com/bradymholt/cron-expression-descriptor/issues/65">issue was opened</a> on my <a href="https://github.com/bradymholt/cron-expression-descriptor">cron-expression-descriptor</a> project asking about support for .NET Core.  It took me a year to finally get it done (mostly because of laziness) and I would like to share the process of porting it.</p>

<h2 id="getting-standard">Getting Standard</h2>

<p>Searching around for “how to port a .NET Framework library to .NET Core” turned up some results but most of the articles were long and I didn’t really understand the <em>big picture</em> of the process.  I didn’t understand, for example, what the end result would be.  I had questions like:</p>

<ul>
  <li>Will I end up with two assemblies, one for .NET Framework and one for .NET Core which will be packaged together in a single NuGet package?</li>
  <li>Will I need need to create an entirely separate NuGet package for .NET Core that will stand alone?</li>
  <li>If I am able to build a single assembly that will work on .NET Framework or .NET Core, will I have to use compile flags for features not supported in .NET Core yet?</li>
  <li>Since .NET Core uses project.json file, will I need one of those and also a .csproj for .NET Framework?  So, I’ll need two project files for my library?</li>
</ul>

<p>You can see some of this confusion in one of the <a href="https://github.com/bradymholt/cron-expression-descriptor/issues/65#issuecomment-237626977">comments I posted on the issue</a>. Most of the articles didn’t address these questions, at least not the ones I referenced.  I saw lots of things about running the <a href="https://docs.microsoft.com/en-us/dotnet/standard/portability-analyzer">The .NET Portability Analyzer</a> to see what things would need to be changed to enable a library to on on .NET Core and the process of switching out unsupported features with alternatives.</p>

<h2 id="portability-analyzer">Portability Analyzer</h2>
<p>So, I started with the The .NET Portability Analyzer and found that I was in fairly good shape, mostly thanks to the fact that Cron Expression Descriptor doesn’t have any external depedencies.  There were minor things like <code class="highlighter-rouge">ToTitleCase</code> that wouldn’t work on .NET Core but the big on was the absense of <code class="highlighter-rouge">System.Threading.Thread.CurrentCulture</code>.  This was being used to determine the i18n setting to use at runtime, which affects the language of the output.  Ok, I realized I’m probably going to need to rip most of that out and just allow the culture settings to be specified as runtime options.</p>

<p><amp-img src="/media/portability-analyzer-results.png" alt=".NET Portability Analyzer Results" width="1092" height="838" layout="responsive"><noscript><img src="/media/portability-analyzer-results.png" alt=".NET Portability Analyzer Results" width="1092" height="838"></noscript></amp-img></p>

<h2 id="initial-work">Initial Work</h2>

<p>I opened a <a href="https://github.com/bradymholt/cron-expression-descriptor/pull/66">Pull Request</a> with the intial work to get the Portability Analyzer happy and green.  And then, I <strong>did nothing for a year</strong>.  A full year I let this PR sit around.  Why?  I lost some momentium of interest but I also bumped into my original questions and still didn’t know the answers.  I thought, “Ok, I’ve got the Portability Analyzer” happy but now what”?  My library is .NET Core compatiable but what about all the other stuff?  Do I need to just install .NET Core, change some values in the .csproj, build it and then ship it?  How do I know it will continue to work on earlier .NET Framework versions like 3.5?</p>

<h2 id="net-standard">.NET Standard</h2>

<p>Fortunately, in the year that had past, things got better.  The articles online were better and <em>most importantly</em>, <a href="https://blogs.msdn.microsoft.com/dotnet/2016/09/26/introducing-net-standard/">.NET Standard was announced</a>.  This was really the missing piece that made things much clearer for me.  “Oh!  Ok, so I can just tell my library to target .NET Standard, build it, and then it will run on any platform that supports the .NET Standard version I targeted.  That makes sense.”.  Now, I was starting to understand the big picture.</p>

<h2 id="making-progress">Making Progress</h2>

<p>Eventually, I installed <a href="https://www.visualstudio.com/downloads/">Visual Studio Community 2017</a>, which had tooling for .NET Standard, and created a brand new C# library project using the .NET Core starter templates.  I wrote up a quick “Hello World” .NET Standard library and then referenced it from a .NET Framework console app.  Once I got this working, I knew I was moving in the right direction.  I then created a .NET Core console app (from the starter templates of course) and referenced that same library and confirmed it worked.  Cool, so now I’ve got a .NET Standard library that can be consumed from a .NET Framework and .NET Core application.</p>

<p>I opened on the .csproj for my “Hello World” .NET Standard library to see where the magic was.  To my surprise, it was super simple.  <em>Much</em> more condenced than what I am used to seeing in a .csproj file.  I figured out what I need to change in the CronExpressionDescriptor.csproj project file and ended up with <a href="https://github.com/bradymholt/cron-expression-descriptor/pull/66/commits/3115c7858b1f323df510dd204c95529b93c93899#diff-86061dc6e522408b7744126576100654">this</a>.</p>

<p><amp-img src="/media/ced-core-csproj.png" alt="csproj changes for .NET Standard" width="1800" height="1846" layout="responsive"><noscript><img src="/media/ced-core-csproj.png" alt="csproj changes for .NET Standard" width="1800" height="1846"></noscript></amp-img></p>

<p>The above screenshot isn’t even the entire diff.  It’s <a href="https://github.com/bradymholt/cron-expression-descriptor/pull/66/commits/3115c7858b1f323df510dd204c95529b93c93899#diff-86061dc6e522408b7744126576100654">twice as long</a> as that.  Crazy!  Some of the key chages were:</p>

<ul>
  <li>The Project tag <code class="highlighter-rouge">&lt;Project ToolsVersion="13.0" DefaultTargets...</code> needed to be changed simply to <code class="highlighter-rouge">&lt;Project Sdk="Microsoft.NET.Sdk"&gt;</code>.</li>
  <li>
<code class="highlighter-rouge">&lt;TargetFrameworkVersion/&gt;</code> changed to <code class="highlighter-rouge">&lt;TargetFramework/&gt;</code>
</li>
  <li>Remove all the <code class="highlighter-rouge">&lt;Compile Include=...</code> statements referencing all the project files.  The new csproj format includes files in the directory by default.  This is a major improvement!</li>
</ul>

<p>Once I made the changes and the library built, I knew it was smooth sailing from here.  I just needed to build it, package it and push it up to NuGet.  As I was doing this, I ran into some issues with getting NUnit tests to work and eventually <a href="https://github.com/bradymholt/cron-expression-descriptor/pull/66/commits/c13165a8994bc5d463ddbef1322e9680ea7e1501">swapped out NUnit for xUnit</a> which has better .NET Core / .NET Standard support.</p>

<h2 id="moving-to-vscode-on-macos">Moving to VSCode on macOS</h2>

<p>I’ve used macOS as my primary OS for a several years now and am quite comfortable there.  I feel right at home using VSCode and only booting my Windows 10 VitualBox machine when I have to.  This includes when I need to do work on Cron Expression Descriptor.  I wanted to move over completely to macOS for development moving forward.  So, after some fiddling and Googling, I got everything (build, tests, publishing to NuGet) running on from macOS.  This was huge!  .NET is truly cross-platform!  Now, moving forward, I never have to boot my Windows 10 box to work on this library.  In the <a href="https://github.com/bradymholt/cron-expression-descriptor/pull/66/commits">commit history</a> you’ll see commits related to this switch, namely VSCode tasks setup.</p>

<p>If you look at my <a href="https://github.com/bradymholt/cron-expression-descriptor/blob/master/RELEASING.md">RELEASING.md</a> doc, you’ll see that as long as you have .NET Core SDK installed (on Windows <em>or</em> macOS <em>or</em> Linux) and bash (via Linux Subsystem on Windows), you can run <code class="highlighter-rouge">./build/release.sh</code> to run the tests, build the assembly and push up a new package to NuGet.</p>

<h2 id="the-big-picture">The Big Picture</h2>

<p>At the beginning of this process, I didn’t understand the big picture.  Now I do, obviously.  The big picutre with porting a .NET Framework library to .NET Core is this:</p>

<blockquote>
  <p>If your library targets a version of .NET Standard, it can be referenced and used from an application running on a .NET platform that suports that version of .NET Standard</p>
</blockquote>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>