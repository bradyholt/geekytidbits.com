<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>Simple Deploy Script for Rails</title>
    <link rel="canonical" href="https://www.geekytidbits.com/simple-deploy-script-rail/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Jul 9, 2013</i>
      </span>
      <p>I’ve been working with Rails more and more recently on some personal projects and have to say I really like it.  It’s been very beneficial to get outside the box of .NET for awhile and work with a framework like Rails because it has helped me learn new things and approach common problems from a different angle.</p>

<p>One of the obvious things I needed to do with some of my Rails projects was to deploy them to a production server.  It seems like the majority of Rails community either deploys to <a href="https://www.heroku.com/" target="_blank">Heroku</a> or uses <a href="https://github.com/capistrano/capistrano" target="_blank">Capistrano</a> to deploy to a Linux box.  I decided against Heroku b/c I already have an Amazon EC2 server that I would like to utilize.  Also, I actually like having full control over a production server whereas one of the largest appeals of Heroku is to “Forget Servers” as they put it on their own website.  I almost dove in head first to the world of Capistrano but got cold feet as it seemed a bit too heavy.  With Capistrano, there is a bit of a learning curve (see ‘recipes’) and heavy setup based on assumptions.  I just want to deploy my app!</p>

<p>Anyway, I came up with the following script that I have dropped in my Rails project script folders.  I just run ./script/deploy.sh from my web folder, wait a minute and my Rails app is updated in production. Easy cheesy. This script handles runnings tests, local asset pre-compilation, rsync copy to remote server, bundle install, database migrations, and some misc cleanup tasks.  It works like a champ and it’s simple.</p>

<p>Yes, there are still a few assumptions here.  You still need to setup the production server  (I use Nginx and Phusion Passenger) and have the ability to ssh to the server.  Once you have everything setup, this script is perfect for pushing incremental releases to production.</p>

<p><em>deploy.sh</em></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="c">#PREP</span>
<span class="nv">USER_HOST</span><span class="o">=</span><span class="s2">"bholt@myserver.com"</span>
<span class="nv">REMOTE_DIR</span><span class="o">=</span><span class="s2">"~/web/myproj"</span>
<span class="nb">set</span> <span class="nt">-e</span> <span class="c">#exit on any error</span>
git pull

<span class="c">#LOCAL</span>
<span class="c">#run tests</span>
bundle <span class="nb">exec </span>rake <span class="nb">test</span>
<span class="c">#clear temp files</span>
bundle <span class="nb">exec </span>rake tmp:clear
<span class="c">#precompile assets</span>
bundle <span class="nb">exec </span>rake assets:precompile
<span class="c">#copy files</span>
rsync <span class="nt">-rvuz</span> ./ <span class="k">${</span><span class="nv">USER_HOST</span><span class="k">}</span>:<span class="k">${</span><span class="nv">REMOTE_DIR</span><span class="k">}</span> <span class="nt">--exclude</span><span class="o">=</span><span class="s1">'.git/'</span> <span class="nt">--exclude</span><span class="o">=</span><span class="s1">'log/'</span> <span class="nt">--exclude</span><span class="o">=</span><span class="s1">'tmp/cache'</span> <span class="nt">--delete</span>
<span class="c">#clear tmp files after precompile</span>
bundle <span class="nb">exec </span>rake tmp:clear

<span class="c">#REMOTE</span>
<span class="c">#bundle install</span>
ssh <span class="k">${</span><span class="nv">USER_HOST</span><span class="k">}</span> <span class="s1">'cd ${REMOTE_DIR} &amp;&amp; bundle install'</span>
<span class="c">#database migrate</span>
ssh <span class="k">${</span><span class="nv">USER_HOST</span><span class="k">}</span> <span class="s1">'cd ${REMOTE_DIR} &amp;&amp; bundle exec rake db:migrate RAILS_ENV="production"'</span>
<span class="c">#clear temp files</span>
ssh <span class="k">${</span><span class="nv">USER_HOST</span><span class="k">}</span> <span class="s1">'cd ${REMOTE_DIR} &amp;&amp; bundle exec rake tmp:clear'</span>
<span class="c">#clear log files</span>
ssh <span class="k">${</span><span class="nv">USER_HOST</span><span class="k">}</span> <span class="s1">'cd ${REMOTE_DIR} &amp;&amp; bundle exec rake log:clear'</span>
<span class="c">#restart app</span>
ssh <span class="k">${</span><span class="nv">USER_HOST</span><span class="k">}</span> <span class="s1">'touch ${REMOTE_DIR}/tmp/restart.txt'</span>

<span class="nb">echo</span> <span class="s2">"Deploy Successful!"</span>
</code></pre></div></div>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>