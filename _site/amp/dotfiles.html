<!doctype html>
<html amp lang="en">
<head>
    <meta charset="utf-8">
    <title>dotfiles</title>
    <link rel="canonical" href="https://www.geekytidbits.com/dotfiles/" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
    <link href='https://fonts.googleapis.com/css?family=Poly' rel='stylesheet'>
    <style amp-custom>
        body { font-family: 'Poly', serif; }
        .site-header { background-color: #237ab2; color: #e7e9ec; padding: 5px; font-weight: 100; border-bottom: 3px solid #f68905; }
        .site-description { font-size: .5em;}        
        .post-content { padding: 10px; }
    </style>
    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-iframe" src="https://cdn.ampproject.org/v0/amp-iframe-0.1.js"></script>
    <script async custom-element="amp-video" src="https://cdn.ampproject.org/v0/amp-video-0.1.js"></script>
    <script async custom-element="amp-youtube" src="https://cdn.ampproject.org/v0/amp-youtube-0.1.js"></script>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
</head>

<body>
    
    <h1 class="post-title">
        <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <amp-img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" layout="responsive"><noscript><img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo"></noscript></amp-img>
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    </h1>
    <div class="post-content">
      <span>
          <i>Jun 7, 2016</i>
      </span>
      <p>In the last couple of days I have had this sinking feeling that something is going to happen to my MacBook. Like, it’s going to get stolen or it’s going to crash. It’s completely irrational but I’ve taken advantage of the opportunity to do a hypothetical postmortum to determine what I would have done differently.</p>

<p>I do a fairly good job of keeping important things in a safe, backed up location. All of my code is under soure-control, I use LastPass for passwords and software license keys, and I use Google for most everything (Email, Docs, Sheets, Music, Photos) so I don’t have to worry about backing up much.</p>

<p>However, I did realize I would be in a bit of a mess if I lost my “dotfiles”. You know, all the <code class="highlighter-rouge">.filename</code> files in your $HOME folder that many apps use to store your configuration. I have haphazardly backed up some of the more important ones like <code class="highlighter-rouge">.psqlrc</code> (PostgresSQL) but many aren’t backed up. I also have a handful of shell scripts I’ve accumulated that do various things like my beloved <code class="highlighter-rouge">ws</code> script which starts a web server from the local directory and fires up Chrome, pointing to the URL. If I lost this stuff, I would be sad; super sad.</p>

<p>Creating a <a href="https://dotfiles.github.io/">dotfiles repo</a> on GitHub is something I think is a pretty great idea. I’ve been meaning to do this but just kept putting it off. The reason I like using a GitHub repo for these is because they are <strong>versioned</strong>, easily <strong>sharable</strong>, and <strong>restorable</strong>. There are lots of example repos to go off of and you can learn a lot but just looking through them. For my purposes, I wanted something pretty simple and able to gracefully handle <em>secrets</em>.</p>

<p>The final result is here on GitHub: <a href="https://github.com/bradymholt/dotfiles">https://github.com/bradymholt/dotfiles</a></p>

<p>The repo structure is fairly flat and simple:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bin                 <span class="c"># directory containing shell scripts and other misc</span>
                    <span class="c">#   executable utilities; will be symlinked from $HOME/</span>

secrets             <span class="c"># secrets are stored here - this folder is not in the repo</span>
                    <span class="c">#   but is cloned from a private Git repo during setup</span>

.zshrc              <span class="c"># dotfile will be symlinked from $HOME/</span>
.gitconfig          <span class="c"># dotfile will be symlinked from $HOME/</span>
.crontab            <span class="c"># crontab which will be installed during setup</span>
<span class="o">[</span>...]
dotfiles-setup.sh   <span class="c"># the idempotent setup script</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">dotfiles-setup.sh</code> is where all the magic happens:</p>

<ol>
  <li>
<strong>Initialize secrets repo</strong> - A prompt will be given to enter the <em>secrets</em> repo URL. This git repo will be cloned to $DOTFILES_PATH/secrets and symlinked from $HOME/secrets. Obviously, you’ll want to use a git repo that is not publically available. As an example for how this is used, I have a <code class="highlighter-rouge">var</code> file in my <code class="highlighter-rouge">secrets/</code> repo containing secret environmental variables. This secret file is <a href="https://github.com/bradymholt/dotfiles/search?l=bash&amp;q=~%2Fsecrets%2Fvar&amp;utf8=%E2%9C%93">loaded in my .zshrc</a>.</li>
  <li>
<strong>symlink files from ${HOME} to $DOTFILES_PATH/</strong> - All top level objects in $DOTFILES_PATH will be symlinked from $HOME (with exception of .git/, and dotfiles*).</li>
  <li>
<strong>symlink external config</strong> - This is where other symlinks are created for application specific needs. For example, <a href="https://itunes.apple.com/us/app/bettersnaptool/id417375580?mt=12">BetterSnapTool</a> stores its config in <code class="highlighter-rouge">${HOME}/Library/Preferences/com.hegenberg.BetterSnapTool.plist</code> and I have a dotfiles config located at $HOME/.BetterSnapTool (symlinked to <code class="highlighter-rouge">$DOTFILES_PATH/.BetterSnapTool</code> in step #2 above!). During this step, a symlink is created: <code class="highlighter-rouge">${HOME}. /Library/Preferences/com.hegenberg.BetterSnapTool.plist &gt; $HOME/.BetterSnapTool</code>. This step allows me to keep my dotfiles symlinked under $HOME and then do additional, one-off linking when necessary.</li>
  <li>
<strong>symlink ssh key to $HOME/secrets/id_rsa[.pub]</strong> - Symlink my keypair to the secrets folder. I know, Edward Snowden would be horrified.</li>
  <li>
<strong>Setup crontab</strong> - The <code class="highlighter-rouge">.crontab</code> file is installed. Unfortunately OS X 10.11 (at least) seems to have a security mechanism that prevents automatic installation of crontabs. So, the setup script will install the crontab but then run <code class="highlighter-rouge">crontab -e</code> and instruct the user that a material change must be made to the crontab for it to be full installed.</li>
</ol>

<p><em>dotfiles-setup.sh</em></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>

<span class="nb">echo</span> <span class="s2">"#######################"</span>
<span class="nb">echo</span> <span class="s2">"BRADY'S DOTFILES SETUP"</span>
<span class="nb">echo</span> <span class="s2">"#######################"</span>

<span class="nv">DOTFILES_PATH</span><span class="o">=</span><span class="k">$(</span><span class="nb">cd</span> <span class="sb">`</span><span class="nb">dirname</span> <span class="nv">$0</span><span class="sb">`</span> <span class="o">&amp;&amp;</span> <span class="nb">pwd</span><span class="k">)</span>
<span class="nv">CURRENT_SCRIPT_NAME</span><span class="o">=</span><span class="k">${</span><span class="nv">0</span><span class="p">##*/</span><span class="k">}</span>

<span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="o">=</span><span class="s2">""</span>
<span class="k">while </span><span class="nb">true</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'If files exist or are already symlinked, do you want to replace?\nAnswer [y]es, [n]o, or [p]rompt: '</span><span class="k">)</span><span class="s2">"</span> yn
    <span class="k">case</span> <span class="nv">$yn</span> <span class="k">in</span>
        <span class="o">[</span>Yy]<span class="k">*</span> <span class="p">)</span> <span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="o">=</span><span class="s2">"f"</span><span class="p">;</span> <span class="nb">break</span><span class="p">;;</span>
        <span class="o">[</span>Nn]<span class="k">*</span> <span class="p">)</span> <span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="o">=</span><span class="s2">""</span><span class="p">;</span> <span class="nb">break</span><span class="p">;;</span>
        <span class="o">[</span>Pp]<span class="k">*</span> <span class="p">)</span> <span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="o">=</span><span class="s2">"i"</span><span class="p">;</span> <span class="nb">break</span><span class="p">;;</span>
        <span class="k">*</span> <span class="p">)</span> <span class="nb">echo</span> <span class="s2">"Please answer: "</span><span class="p">;;</span>
    <span class="k">esac</span>
<span class="k">done

</span><span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"STEP 1: Initialize secrets repo"</span>
<span class="nv">SECRETS_FOLDER</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">DOTFILES_PATH</span><span class="k">}</span><span class="s2">/secrets"</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="k">${</span><span class="nv">SECRETS_FOLDER</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"The secrets repo has already initialized!"</span>
<span class="k">else
  </span><span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"</span><span class="k">$(</span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s1">'The secrets repo needs to be initialized.\nEnter the secrets repo URL (i.e. https://gist.github.com/bradyholt/123456): '</span><span class="k">)</span><span class="s2">"</span> SECRETS_REPO_URL
  git clone <span class="nv">$SECRETS_REPO_URL</span> <span class="nv">$SECRETS_FOLDER</span>
<span class="k">fi</span>

<span class="c"># [Re]create symbolic links from $HOME to ./*</span>
<span class="c"># Only top level files/directories will be symlinked</span>
<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"STEP 2: symlink files from </span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2"> to </span><span class="k">${</span><span class="nv">DOTFILES_PATH</span><span class="k">}</span><span class="s2">/"</span>
find <span class="nv">$DOTFILES_PATH</span> <span class="nt">-maxdepth</span> 1 <span class="nt">-mindepth</span> 1 <span class="se">\(</span> <span class="o">!</span> <span class="nt">-iname</span> <span class="s2">"dotfiles*"</span> <span class="o">!</span> <span class="nt">-iname</span> <span class="s2">".git"</span> <span class="o">!</span> <span class="nt">-iname</span> <span class="s2">".gitignore"</span> <span class="o">!</span> <span class="nt">-iname</span> <span class="s2">"README.md"</span> <span class="se">\)</span> <span class="nt">-exec</span> <span class="nb">ln</span> <span class="nt">-sv</span><span class="k">${</span><span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="k">}</span> <span class="o">{}</span> <span class="nv">$HOME</span> <span class="s1">';'</span>

<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"STEP 3: symlink external config"</span>
<span class="c"># VS Code</span>
<span class="nb">ln</span> <span class="nt">-sv</span><span class="k">${</span><span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/.vscode.settings.json"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/Library/Application Support/Code/User/settings.json"</span>
<span class="nb">ln</span> <span class="nt">-sv</span><span class="k">${</span><span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/.vscode.keybindings.json"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/Library/Application Support/Code/User/keybindings.json"</span>

<span class="c"># BetterSnapTool config - The format of the config is complicated so if something ever goes wrong and manual config is needed, here is a screenshot of the important settings: https://cloud.githubusercontent.com/assets/759811/15751225/f76b950c-28ae-11e6-9fd9-7c83aad698b2.png</span>
<span class="nb">ln</span> <span class="nt">-sv</span><span class="k">${</span><span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/.BetterSnapTool"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/Library/Preferences/com.hegenberg.BetterSnapTool.plist"</span>

<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"STEP 4: symlink ssh key to </span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/secrets/id_rsa[.pub]"</span>
<span class="c">#Key pairs</span>
<span class="nb">ln</span> <span class="nt">-sv</span><span class="k">${</span><span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/secrets/id_rsa"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/.ssh/id_rsa"</span>
<span class="nb">ln</span> <span class="nt">-sv</span><span class="k">${</span><span class="nv">LINK_TARGET_EXISTS_HANDLING</span><span class="k">}</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/secrets/id_rsa.pub"</span> <span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/.ssh/id_rsa.pub"</span>

<span class="nb">echo</span> <span class="s2">""</span>
<span class="nb">echo</span> <span class="s2">"STEP 5: Setup crontab"</span>
<span class="nb">echo</span> <span class="s2">"backing up user crontab to /tmp/crontab.bk"</span>
crontab <span class="nt">-l</span> <span class="o">&gt;</span> /tmp/crontab.bk
<span class="nb">echo</span> <span class="s2">"Replacing user crontab with contents of </span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/.crontab"</span>
crontab <span class="k">${</span><span class="nv">HOME</span><span class="k">}</span>/.crontab
<span class="nb">echo</span> <span class="s2">"NOTE: Because of an OS X security block, you will need to manually make a material change to your crontab before it will be installed."</span>
<span class="nb">echo</span> <span class="s2">"Your crontab will be opened next; you should make a material change (i.e. add a comment on a new line) and save it"</span>
<span class="nb">read</span> <span class="nt">-p</span> <span class="s2">"Press any key to continue"</span>
crontab <span class="nt">-e</span>
</code></pre></div></div>

    </div>
    
    <footer class="site-footer">
    © 2019 Brady Holt
</footer>

    <amp-analytics type="googleanalytics">
        <script type="application/json">
        {
            "vars": {
            "account": "UA-19416043-2"
            },
            "triggers": {
            "trackPageview": {
                "on": "visible",
                "request": "pageview"
            }
            }
        }
        </script>
    </amp-analytics>
</body>

</html>