<!DOCTYPE html>
<html lang="en">


<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Rolling snapshots for EC2 | Geeky Tidbits</title>
    <meta name="description" content="One of the best things about EBS backed EC2 instances is the ability to create snapshots.  To say this makes backing up your instances “easy” would be an und...">
    <link href='//fonts.googleapis.com/css?family=IBM+Plex+Serif' rel='stylesheet' type='text/css'>
    <style>body,h1,h2,h3,h4,h5,h6,p,blockquote,pre,hr,dl,dd,ol,ul,figure{margin:0;padding:0;-webkit-font-smoothing:antialiased}body{font-family:"IBM Plex Serif",serif;font-size:1.2em;line-height:1.5;font-weight:300;color:#444;background-color:#f7f7f7;-webkit-text-size-adjust:100%}h1,h2,h3,h4,h5,h6,p,blockquote,pre,ul,ol,dl,figure{margin-bottom:15px}img{max-width:100%;vertical-align:middle}figure>img{display:block}ul,ol{margin-left:30px}ul.condensed{columns:2;-webkit-columns:2;-moz-columns:2;list-style-type:disc;list-style-position:inside}li>ul,li>ol{margin-bottom:0}h2,h3,h4,h5,h6{font-weight:300}h1{font-weight:600;font-size:42px;line-height:1;padding-top:35px}@media screen and (max-width: 600px){h1{font-size:36px}}a{color:#126ca6;text-decoration:none}a:visited{color:#126ca6}a:hover{color:#178ad4}blockquote{color:#828282;padding-left:15px;font-size:18px;letter-spacing:-1px;font-style:italic}blockquote>:last-child{margin-bottom:0}pre{font-size:1em;padding:8px 12px;overflow-x:scroll}code{background-color:#f8f8f8}time{margin-right:10px}.wrapper{position:relative;width:800px;margin-right:auto;margin-left:auto;padding-right:30px;padding-left:30px;border-left:solid 225px transparent}@media screen and (max-width: 1085px){.wrapper{width:auto;border-left:0}}.page-content .wrapper{border-left:solid 225px #f7f7f7;background-color:#fff;padding-bottom:50px}@media screen and (max-width: 1085px){.page-content .wrapper{width:auto}}@media screen and (max-width: 600px){.page-content .wrapper{border-left:0}}.wrapper:after{content:"";display:table;clear:both}.icon>svg{display:inline-block;width:16px;height:16px;vertical-align:middle}.icon>svg path{fill:#828282}.site-header{border-bottom:3px solid #f68905;background-color:#237ab2;padding-bottom:10px;color:white;position:relative}.site-header img{margin-top:10px}.site-title{font-size:26px;line-height:56px;letter-spacing:-1px;margin-bottom:0}.site-description{font-size:17px}.site-footer{padding:10px 0 30px;color:#828282;font-style:italic}.page-content img{margin:20px}.post-header{margin-bottom:20px}.post .post-meta{display:inline-block;border:1px solid rgba(0,0,0,0.05);border-left:none;border-right:none;padding:8px 0 8px 30px;margin-top:10px;margin-left:-30px}.post-content h2{font-size:32px}@media screen and (max-width: 600px){.post-content h2{font-size:28px}}.post-content h3{font-size:26px}@media screen and (max-width: 600px){.post-content h3{font-size:22px}}.post-content h4{font-size:20px}@media screen and (max-width: 600px){.post-content h4{font-size:18px}}.post-list{margin-left:0;list-style:none}.post-list>li{margin-bottom:30px}.post-list img{max-height:100px}.post-meta{font-size:1em;color:#828282}.post-link{display:block;font-size:24px}.sidebar{font-size:16px;position:absolute;left:-195px;width:195px}.sidebar ul{margin-left:0px;list-style:none}.sidebar ul li{transition:all 0.2s ease-in-out}.sidebar ul li:hover{transform:scale(1.1)}.sidebar ul li a{text-decoration:none}.sidebar svg.social{width:25px;height:25px;margin:5px;vertical-align:middle}.sidebar img.head-shot{width:145px;height:145px;border-radius:75px;margin:10px 0}.sidebar h3{margin-bottom:0;font-weight:bold}.sidebar h4{font-style:italic;font-size:15px}.sidebar .site-nav{font-size:larger;line-height:30px}@media screen and (max-width: 600px){.sidebar{position:static;width:100%;text-align:center;display:none}.sidebar .head-shot{display:inline-block}.sidebar ul.social-links{width:150px;text-align:left;margin:0 auto;padding-left:20px}}@media screen and (max-width: 600px){body.home .sidebar{display:block}ul.condensed{columns:1;-webkit-columns:1;-moz-columns:1}}.pull-right{float:right !important}.pull-left{float:left !important}.block{display:block}.no-margin{margin:0px !important}table{table-layout:fixed;width:100%;border-collapse:collapse;margin:10px 0 20px 0}table th{text-align:left}table th,table td{padding:5px;border:1px solid lightgray}.highlight .hll{background-color:#ffffcc}.highlight{background:#f8f8f8}.highlight .c{color:#408080;font-style:italic}.highlight .err{border:1px solid #ff0000}.highlight .k{color:#008000;font-weight:bold}.highlight .o{color:#666666}.highlight .ch{color:#408080;font-style:italic}.highlight .cm{color:#408080;font-style:italic}.highlight .cp{color:#bc7a00}.highlight .cpf{color:#408080;font-style:italic}.highlight .c1{color:#408080;font-style:italic}.highlight .cs{color:#408080;font-style:italic}.highlight .gd{color:#a00000}.highlight .ge{font-style:italic}.highlight .gr{color:#ff0000}.highlight .gh{color:#000080;font-weight:bold}.highlight .gi{color:#00a000}.highlight .go{color:#888888}.highlight .gp{color:#000080;font-weight:bold}.highlight .gs{font-weight:bold}.highlight .gu{color:#800080;font-weight:bold}.highlight .gt{color:#0044dd}.highlight .kc{color:#008000;font-weight:bold}.highlight .kd{color:#008000;font-weight:bold}.highlight .kn{color:#008000;font-weight:bold}.highlight .kp{color:#008000}.highlight .kr{color:#008000;font-weight:bold}.highlight .kt{color:#b00040}.highlight .m{color:#666666}.highlight .s{color:#ba2121}.highlight .na{color:#7d9029}.highlight .nb{color:#008000}.highlight .nc{color:#0000ff;font-weight:bold}.highlight .no{color:#880000}.highlight .nd{color:#aa22ff}.highlight .ni{color:#999999;font-weight:bold}.highlight .ne{color:#d2413a;font-weight:bold}.highlight .nf{color:#0000ff}.highlight .nl{color:#a0a000}.highlight .nn{color:#0000ff;font-weight:bold}.highlight .nt{color:#008000;font-weight:bold}.highlight .nv{color:#19177c}.highlight .ow{color:#aa22ff;font-weight:bold}.highlight .w{color:#bbbbbb}.highlight .mb{color:#666666}.highlight .mf{color:#666666}.highlight .mh{color:#666666}.highlight .mi{color:#666666}.highlight .mo{color:#666666}.highlight .sa{color:#ba2121}.highlight .sb{color:#ba2121}.highlight .sc{color:#ba2121}.highlight .dl{color:#ba2121}.highlight .sd{color:#ba2121;font-style:italic}.highlight .s2{color:#ba2121}.highlight .se{color:#bb6622;font-weight:bold}.highlight .sh{color:#ba2121}.highlight .si{color:#bb6688;font-weight:bold}.highlight .sx{color:#008000}.highlight .sr{color:#bb6688}.highlight .s1{color:#ba2121}.highlight .ss{color:#19177c}.highlight .bp{color:#008000}.highlight .fm{color:#0000ff}.highlight .vc{color:#19177c}.highlight .vg{color:#19177c}.highlight .vi{color:#19177c}.highlight .vm{color:#19177c}.highlight .il{color:#666666}
</style>
    <link rel="canonical" href="https://www.geekytidbits.com/rolling-snapshots-ec2/">
    <link rel="alternate" type="application/rss+xml" title="Geeky Tidbits" href="https://www.geekytidbits.com/feed/" />
    <link rel="amphtml" href="https://www.geekytidbits.com/amp/rolling-snapshots-ec2.html">
</head>

<body>
    <header class="site-header">
    <div class="wrapper">
        <a class="site-title" href="/">
            <img src="/media/geekytidbits.png" width="383" height="46" alt="Geeky Tidbits Logo" />
        </a>
        <div class="site-description">Tidbits on software development, technology, and other geeky stuff.</div>
    </div>
</header>

    <div class="page-content">
        <div class="wrapper">
            <div class="sidebar">
    <img class="head-shot" alt="Brady Holt" width="145px" height="145px" src="//s.gravatar.com/avatar/ae474dd4a074fd22e897c4c54770c05a?s=290">
    <h3>Brady Holt</h3>
    <h4>Geek, developer at <a target="_blank" href="http://www.youneedabudget.com/">YNAB</a>, voider of warranties</h4>
    <nav class="site-nav">
        <ul> 
            <li>
                <a class="page-link" href="/about-me/">About Me</a>
            </li>
            <li>
                <a class="page-link" href="/projects/">Projects</a>
            </li>
            <li>
                <a class="page-link" href="/posts/">Posts</a>
            </li>
        </ul>
    </nav>
    <p>Connect with me!</p>
    <ul class="social-links">
        <li>
            <a href="http://github.com/bradymholt">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M16 0c-8.837 0-16 7.163-16 16s7.163 16 16 16 16-7.163 16-16-7.163-16-16-16zM25.502 25.502c-1.235 1.235-2.672 2.204-4.272 2.881-0.406 0.172-0.819 0.323-1.238 0.453v-2.398c0-1.26-0.432-2.188-1.297-2.781 0.542-0.052 1.039-0.125 1.492-0.219s0.932-0.229 1.438-0.406 0.958-0.388 1.359-0.633 0.786-0.563 1.156-0.953 0.68-0.833 0.93-1.328 0.448-1.089 0.594-1.781 0.219-1.456 0.219-2.289c0-1.615-0.526-2.99-1.578-4.125 0.479-1.25 0.427-2.609-0.156-4.078l-0.391-0.047c-0.271-0.031-0.758 0.083-1.461 0.344s-1.492 0.688-2.367 1.281c-1.24-0.344-2.526-0.516-3.859-0.516-1.344 0-2.625 0.172-3.844 0.516-0.552-0.375-1.075-0.685-1.57-0.93s-0.891-0.411-1.188-0.5-0.573-0.143-0.828-0.164-0.419-0.026-0.492-0.016-0.125 0.021-0.156 0.031c-0.583 1.479-0.635 2.839-0.156 4.078-1.052 1.135-1.578 2.51-1.578 4.125 0 0.833 0.073 1.596 0.219 2.289s0.344 1.286 0.594 1.781 0.56 0.938 0.93 1.328 0.755 0.708 1.156 0.953 0.854 0.456 1.359 0.633 0.984 0.313 1.438 0.406 0.95 0.167 1.492 0.219c-0.854 0.583-1.281 1.51-1.281 2.781v2.445c-0.472-0.14-0.937-0.306-1.394-0.5-1.6-0.677-3.037-1.646-4.272-2.881s-2.204-2.672-2.881-4.272c-0.7-1.655-1.055-3.414-1.055-5.23s0.355-3.575 1.055-5.23c0.677-1.6 1.646-3.037 2.881-4.272s2.672-2.204 4.272-2.881c1.655-0.7 3.415-1.055 5.23-1.055s3.575 0.355 5.23 1.055c1.6 0.677 3.037 1.646 4.272 2.881s2.204 2.672 2.881 4.272c0.7 1.655 1.055 3.415 1.055 5.23s-0.355 3.575-1.055 5.23c-0.677 1.6-1.646 3.037-2.881 4.272z"></path>
                </svg>GitHub
            </a>
        </li>
        <li>
            <a href="http://stackoverflow.com/users/626911/brady?tab=profile">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M32 20v12h-32v-12h4v8h24v-8zM6 22h20v4h-20zM6.473 17.671l0.866-3.905 19.526 4.328-0.866 3.905zM8.739 9.642l1.69-3.625 18.126 8.452-1.69 3.625zM30.991 11.296l-2.435 3.173-15.867-12.175 1.761-2.294h1.82z"></path>
                </svg>Stack Overflow
            </a>
        </li>
        <li>
            <a href="http://twitter.com/bradymholt">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M32 6.076c-1.177 0.522-2.443 0.875-3.771 1.034 1.355-0.813 2.396-2.099 2.887-3.632-1.269 0.752-2.674 1.299-4.169 1.593-1.198-1.276-2.904-2.073-4.792-2.073-3.626 0-6.565 2.939-6.565 6.565 0 0.515 0.058 1.016 0.17 1.496-5.456-0.274-10.294-2.888-13.532-6.86-0.565 0.97-0.889 2.097-0.889 3.301 0 2.278 1.159 4.287 2.921 5.465-1.076-0.034-2.088-0.329-2.974-0.821-0.001 0.027-0.001 0.055-0.001 0.083 0 3.181 2.263 5.834 5.266 6.437-0.551 0.15-1.131 0.23-1.73 0.23-0.423 0-0.834-0.041-1.235-0.118 0.835 2.608 3.26 4.506 6.133 4.559-2.247 1.761-5.078 2.81-8.154 2.81-0.53 0-1.052-0.031-1.566-0.092 2.905 1.863 6.356 2.95 10.064 2.95 12.076 0 18.679-10.004 18.679-18.68 0-0.285-0.006-0.568-0.019-0.849 1.283-0.926 2.396-2.082 3.276-3.398z"></path>
                </svg>Twitter
            </a>
        </li>
        <li>
            <a href="http://www.linkedin.com/in/bradymholt">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M12 12h5.535v2.837h0.079c0.77-1.381 2.655-2.837 5.464-2.837 5.842 0 6.922 3.637 6.922 8.367v9.633h-5.769v-8.54c0-2.037-0.042-4.657-3.001-4.657-3.005 0-3.463 2.218-3.463 4.509v8.688h-5.767v-18z"></path>
                    <path fill="#444444" d="M2 12h6v18h-6v-18z"></path>
                    <path fill="#444444" d="M8 7c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-1.657 1.343-3 3-3s3 1.343 3 3z"></path>
                </svg>LinkedIn
            </a>
        </li>
        <li>
            <a href="/feed/">
                <svg class="social" viewBox="0 0 35 35">
                    <path fill="#444444" d="M4.259 23.467c-2.35 0-4.259 1.917-4.259 4.252 0 2.349 1.909 4.244 4.259 4.244 2.358 0 4.265-1.895 4.265-4.244-0-2.336-1.907-4.252-4.265-4.252zM0.005 10.873v6.133c3.993 0 7.749 1.562 10.577 4.391 2.825 2.822 4.384 6.595 4.384 10.603h6.16c-0-11.651-9.478-21.127-21.121-21.127zM0.012 0v6.136c14.243 0 25.836 11.604 25.836 25.864h6.152c0-17.64-14.352-32-31.988-32z"></path>
                </svg>Feed
            </a>
        </li>
    </ul>
</div>
 <div class="post">
    <header class="post-header">
        <h1 class="post-title">Rolling snapshots for EC2</h1>
        <p class="post-meta">Oct 26, 2012</p>
    </header>
    <article class="post-content">
        <p>One of the best things about EBS backed EC2 instances is the ability to create <a href="http://docs.amazonwebservices.com/AWSEC2/latest/UserGuide/ebs-creating-snapshot.html" target="_blank">snapshots</a>.  To say this makes backing up your instances “easy” would be an understatement.  You can create these snapshots manually through the AWS Management Console and also using the <a href="http://docs.amazonwebservices.com/AWSEC2/latest/CommandLineReference/ApiReference-cmd-CreateSnapshot.html" target="_blank">ec2-create-snapshot</a> API command line tool.  The cost of these snapshots is just $0.125 per GB of data stored and incremental snapshots only store changed data so it’s really cheap to make lots of snapshots.</p>

<p>I wanted to be able to setup a daily cron job to automatically snapshot my EC2 instance so I wouldn’t have to worry about backups.  If I ever had a failure or data loss I could simply grab the automatically created snapshot from the previous day and restore it.  Running ec2-create-snapshop with cron is easy enough but there is a 500 count limit to snapshots and I really don’t want to keep hundreds of snapshots.  I really wanted to just keep a handful of ‘latest” snapshots.</p>

<p>Searching around I came cross a script that handled “rolling” snapshots which basically means it will create a snapshot and delete older ones to keep a specified number of latest snapshots.  This is exactly what I wanted.  The script I found was a bit outdated and needed some updates but I was able to make the needed changes fairly easily.  Here’s how you use it:</p>

<p><strong>Usage</strong>:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ec2-create-rolling-snapshot <span class="o">[</span>OPTIONS] <span class="nt">-d</span> DESCRIPTION VOLUME MAX_SNAPSHOTS
</code></pre></div></div>

<p><strong>Example</strong> (keeps 7 most recent snapshots):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ec2-create-rolling-snapshot <span class="nt">-d</span> <span class="s2">"Daily backup-vol-fzz00z0z"</span> vol-fzz00z0z 7
</code></pre></div></div>

<p>This script depends on, and assumes the <a href="http://aws.amazon.com/developertools/351" target="_blank">Amazon EC2 API Tools</a> are installed.  If you are running Amazon Linux these should already be installed.  You’ll need to ensure the following environment variables are set and available at runtime.  If you are running from cron, remember, you’ll need to set these manually in your crontab or a wrapper script as environment variables set in your shell are not available at cron runtime.</p>

<ul>
  <li>AWS_ACCESS_KEY</li>
  <li>AWS_SECRET_KEY</li>
  <li>EC2_HOME</li>
  <li>JAVA_HOME</li>
</ul>

<p>Here’s the script:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c"># Rolling snapshots for ec2</span>
<span class="c"># Original version: 2010-05-28 by cwilper</span>
<span class="c"># Updated: 2012-10-25 by brady@geekytidbits.com</span>

<span class="c"># (Invoke with -h for more info)</span>

showHelp<span class="o">()</span> <span class="o">{</span>
  <span class="nb">echo</span> <span class="s2">"SYNOPSIS"</span>
  <span class="nb">echo</span> <span class="s2">"   ec2-create-rolling-snapshot [OPTIONS] -d DESCRIPTION VOLUME MAX_SNAPSHOTS"</span>
  <span class="nb">echo</span> <span class="s2">"DESCRIPTION"</span>
  <span class="nb">echo</span> <span class="s2">"   Create a snapshot of a volume and delete the oldest snapshot"</span>
  <span class="nb">echo</span> <span class="s2">"   in the series, if necessary."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   The VOLUME parameter is the name of an existing volume."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   The DESCRIPTION parameter specifies the description to use for the"</span>
  <span class="nb">echo</span> <span class="s2">"   new snapshot. All snapshots in a series will have the same description."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   The MAX_SNAPSHOTS parameter specifies the maximum number of snapshots"</span>
  <span class="nb">echo</span> <span class="s2">"   in the series. If creation of the new snapshot exceeds this threshold,"</span>
  <span class="nb">echo</span> <span class="s2">"   the oldest snapshot in the series will be deleted."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"OPTIONS"</span>
  <span class="nb">echo</span> <span class="s2">"   Any option below may be passed a value of '-' to indicate that values"</span>
  <span class="nb">echo</span> <span class="s2">"   for that option should be read from stdin."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -O, --aws-access-key KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        AWS Access Key ID. Defaults to the value of the AWS_ACCESS_KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        environment variable (if set)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -W, --aws-secret-key KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        AWS Secret Access Key. Defaults to the value of the AWS_SECRET_KEY"</span>
  <span class="nb">echo</span> <span class="s2">"        environment variable (if set)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -T, --security-token TOKEN"</span>
  <span class="nb">echo</span> <span class="s2">"        AWS delegation token. Defaults to the value of the AWS_DELEGATION_TOKEN"</span>
  <span class="nb">echo</span> <span class="s2">"        environment variable (if set)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -U, --url URL"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify URL as the web service URL to use. Defaults to the value of"</span>
  <span class="nb">echo</span> <span class="s2">"        'https://ec2.amazonaws.com' or to that of the EC2_URL environment"</span>
  <span class="nb">echo</span> <span class="s2">"        variable (if set). Overrides the default."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --region REGION"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify REGION as the web service region to use."</span>
  <span class="nb">echo</span> <span class="s2">"        This option will override the URL specified by the "</span><span class="nt">-U</span> URL<span class="s2">" option"</span>
  <span class="nb">echo</span> <span class="s2">"        and EC2_URL environment variable."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --dry-run"</span>
  <span class="nb">echo</span> <span class="s2">"        Don't create or delete any snapshots; just show what would be done."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   -?, --help"</span>
  <span class="nb">echo</span> <span class="s2">"        Display this help."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --connection-timeout TIMEOUT"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify a connection timeout TIMEOUT (in seconds)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
  <span class="nb">echo</span> <span class="s2">"   --request-timeout TIMEOUT"</span>
  <span class="nb">echo</span> <span class="s2">"        Specify a request timeout TIMEOUT (in seconds)."</span>
  <span class="nb">echo</span> <span class="s2">""</span>
<span class="o">}</span>

<span class="k">while</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">""</span> <span class="o">]</span>
<span class="k">do
  case</span> <span class="nv">$1</span> <span class="k">in</span>
    <span class="nt">-h</span><span class="p">)</span>
      showHelp<span class="p">;</span>
      <span class="nb">exit </span>0<span class="p">;;</span>
    <span class="nt">--help</span><span class="p">)</span>
      showHelp<span class="p">;</span>
      <span class="nb">exit </span>0<span class="p">;;</span>
    -<span class="se">\?</span><span class="p">)</span>
      showHelp<span class="p">;</span>
      <span class="nb">exit </span>0<span class="p">;;</span>
    <span class="nt">--dry-run</span><span class="p">)</span>
      <span class="nv">dryrun</span><span class="o">=</span><span class="nb">true</span><span class="p">;;</span>
    <span class="nt">-d</span><span class="p">)</span>
      <span class="nv">description</span><span class="o">=</span><span class="nv">$2</span><span class="p">;</span>
      <span class="nv">volume</span><span class="o">=</span><span class="nv">$3</span>
      <span class="nv">max_snapshots</span><span class="o">=</span><span class="nv">$4</span><span class="p">;</span>
      <span class="nb">break</span><span class="p">;;</span>
    <span class="nt">--description</span><span class="p">)</span>
      <span class="nv">description</span><span class="o">=</span><span class="nv">$2</span><span class="p">;</span>
      <span class="nv">volume</span><span class="o">=</span><span class="nv">$3</span>
      <span class="nv">max_snapshots</span><span class="o">=</span><span class="nv">$4</span><span class="p">;</span>
      <span class="nb">break</span><span class="p">;;</span>
    <span class="k">*</span><span class="p">)</span>
      <span class="nv">gen_opts</span><span class="o">=</span><span class="s2">"</span><span class="nv">$gen_opts</span><span class="s2"> </span><span class="nv">$1</span><span class="s2">"</span><span class="p">;;</span>
  <span class="k">esac</span>
  <span class="nb">shift</span><span class="p">;</span>
<span class="k">done

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$description</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Required parameter 'DESCRIPTION' missing (-h for usage)"</span>
  <span class="nb">exit </span>1
<span class="k">fi

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$volume</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Required parameter 'VOLUME' missing (-h for usage)"</span>
  <span class="nb">exit </span>1
<span class="k">fi

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$max_snapshots</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"Required parameter 'MAX_SNAPSHOTS' missing (-h for usage)"</span>
  <span class="nb">exit </span>1
<span class="k">else
  if</span> <span class="o">[</span> <span class="nv">$max_snapshots</span> <span class="nt">-lt</span> 1 <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">exit </span>1
  <span class="k">fi
fi

if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: The EC2_HOME environment variable is not defined."</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="c">#if [ -z "$AWS_ACCESS_KEY" ]; then</span>
<span class="c">#  echo "ERROR: The AWS_ACCESS_KEY environment variable is not defined."</span>
<span class="c">#  exit 1</span>
<span class="c">#fi</span>

<span class="c">#if [ -z "$AWS_SECRET_KEY" ]; then</span>
<span class="c">#  echo "ERROR: The AWS_SECRET_KEY environment variable is not defined."</span>
<span class="c">#  exit 1</span>
<span class="c">#fi</span>

<span class="nv">tempfile</span><span class="o">=</span>/tmp/ec2-create-rolling-snapshot-<span class="nv">$$</span>.tmp

<span class="nv">ec2cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">/bin/ec2-create-snapshot</span><span class="nv">$gen_opts</span><span class="s2"> -d </span><span class="se">\"</span><span class="nv">$description</span><span class="se">\"</span><span class="s2"> </span><span class="nv">$volume</span><span class="s2">"</span>
<span class="nv">snapshot_id</span><span class="o">=</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$dryrun</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">eval</span> <span class="nv">$ec2cmd</span> <span class="o">&gt;</span> <span class="nv">$tempfile</span>
  <span class="nv">result</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span><span class="sb">`</span>
  <span class="nv">snapshot_id</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|grep SNAPSHOT|awk <span class="s1">'{print $2}'</span><span class="sb">`</span>
  <span class="nv">snapshot_state</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|grep SNAPSHOT|awk <span class="s1">'{print $4}'</span><span class="sb">`</span>
  <span class="nb">rm</span> <span class="nv">$tempfile</span>
  <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$snapshot_id</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ERROR: Snapshot creation failed"</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
    <span class="nb">exit </span>1
  <span class="k">fi
  if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$snapshot_state</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"pending"</span> <span class="o">]</span> <span class="o">&amp;&amp;</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$snapshot_state</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"completed"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"ERROR: Snapshot state is not pending or completed"</span>
    <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
    <span class="nb">exit </span>1
  <span class="k">fi
  </span><span class="nb">echo</span> <span class="s2">"Created </span><span class="nv">$snapshot_id</span><span class="s2"> from </span><span class="nv">$volume</span><span class="s2">"</span>
<span class="k">else
  </span><span class="nb">echo</span> <span class="s2">"Created snap-TBD from </span><span class="nv">$volume</span><span class="s2"> (not really; this is a dry run)"</span>
<span class="k">fi

</span><span class="nv">ec2cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">/bin/ec2-describe-snapshots</span><span class="nv">$gen_opts</span><span class="s2">"</span>
<span class="nb">eval</span> <span class="nv">$ec2cmd</span> <span class="o">&gt;</span> <span class="nv">$tempfile</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$dryrun</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"SNAPSHOT snap-TBD </span><span class="nv">$volume</span><span class="s2"> pending 9999-99-99T99:99:99+9999 1 </span><span class="nv">$description</span><span class="s2">"</span> <span class="o">&gt;&gt;</span> <span class="nv">$tempfile</span>
<span class="k">fi
</span><span class="nv">result</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span><span class="sb">`</span>
<span class="nv">series</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|grep SNAPSHOT|grep <span class="s2">"</span><span class="nv">$description</span><span class="s2">"</span>|grep <span class="nv">$volume</span>|awk <span class="s1">'{print $5,$2}'</span>|sort|awk <span class="s1">'{print $2}'</span><span class="sb">`</span>
<span class="nb">rm</span> <span class="nv">$tempfile</span>
<span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$series</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  </span><span class="nb">echo</span> <span class="s2">"ERROR: Failed to get snapshot series"</span>
  <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
  <span class="nb">exit </span>1
<span class="k">fi

</span><span class="nv">count</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$series</span><span class="s2">"</span>|wc <span class="nt">-l</span>|awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="nb">echo</span> <span class="s2">"Series now contains </span><span class="nv">$count</span><span class="s2"> snapshots, max is </span><span class="nv">$max_snapshots</span><span class="s2">"</span>
<span class="nv">oldest</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$series</span><span class="s2">"</span>|head <span class="nt">-n</span> 1|awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="k">if</span> <span class="o">[</span> <span class="nv">$count</span> <span class="nt">-gt</span> <span class="nv">$max_snapshots</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
  if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$dryrun</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
    </span><span class="nb">echo</span> <span class="s2">"Deleting </span><span class="nv">$oldest</span><span class="s2">"</span>
    <span class="nv">ec2cmd</span><span class="o">=</span><span class="s2">"</span><span class="nv">$EC2_HOME</span><span class="s2">/bin/ec2-delete-snapshot</span><span class="nv">$gen_opts</span><span class="s2"> </span><span class="nv">$oldest</span><span class="s2">"</span>
    <span class="nb">eval</span> <span class="nv">$ec2cmd</span> <span class="o">&gt;</span> <span class="nv">$tempfile</span>
    <span class="nv">result</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span><span class="sb">`</span>
    <span class="nv">check1</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
    <span class="nv">check2</span><span class="o">=</span><span class="sb">`</span><span class="nb">cat</span> <span class="nv">$tempfile</span>|awk <span class="s1">'{print $2}'</span><span class="sb">`</span>
    <span class="nb">rm</span> <span class="nv">$tempfile</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check1</span><span class="s2">"</span> <span class="o">!=</span> <span class="s2">"SNAPSHOT"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="s2">"</span><span class="nv">$check2</span><span class="s2">"</span> <span class="o">!=</span> <span class="nv">$oldest</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"ERROR: Unexpected output from ec2-delete-snapshot command"</span>
      <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$result</span><span class="s2">"</span>
      <span class="nb">exit </span>1
    <span class="k">fi
  else
    </span><span class="nb">echo</span> <span class="s2">"Deleting </span><span class="nv">$oldest</span><span class="s2"> (not really; this is a dry run)"</span>
  <span class="k">fi
fi

</span><span class="nb">exit </span>0
</code></pre></div></div>

<p>For my own use, I wrapped this script in another script called from cron so I can set the needed environment variables and stop/start MySQL to ensure data integrity at time of snapshotting.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/sh</span>

<span class="c">#Stop mysql to ensure snapshot consistancy</span>
<span class="nb">echo</span> <span class="s2">"Stopping mysql..."</span>
/sbin/service mysqld stop
<span class="nb">echo</span> <span class="s2">"Creating snapshot..."</span>
<span class="nb">export </span><span class="nv">AWS_ACCESS_KEY</span><span class="o">=</span><span class="s2">"AKIDDDDDDDDDDDD"</span>
<span class="nb">export </span><span class="nv">AWS_SECRET_KEY</span><span class="o">=</span><span class="s2">"GQYL9/JKCFNbZ/2/DDDDDDDDDDDDDDDD"</span>
<span class="nb">export </span><span class="nv">EC2_HOME</span><span class="o">=</span>/opt/aws/apitools/ec2
<span class="nb">export </span><span class="nv">JAVA_HOME</span><span class="o">=</span>/usr/lib/jvm/jre
~/ec2-create-rolling-snapshot <span class="nt">-d</span> <span class="s2">"Daily backup-vol-fac00d0d"</span> vol-fac00d0d 7
<span class="nb">echo</span> <span class="s2">"Waiting for snapshot to finish building..."</span>
<span class="nb">sleep </span>10
<span class="nb">echo</span> <span class="s2">"Starting mysql..."</span>
/sbin/service mysqld start
</code></pre></div></div>

<p>I’ve had this setup and running for about 2 months now and it works great. I love a hands-off approach to backing up my server and the piece of mind knowing that I can easily grab and restore a snapshot from last night (or 3 days ago) with a few clicks.</p>

    </article>
    <div id="disqus_thread"></div>
    
    <script type="text/javascript">
        
        var disqus_identifier = '1240 http://www.geekytidbits.com/?p=1240';
        
        var disqus_container_id = 'disqus_thread';
        var disqus_shortname = 'geekytidbits';
        var disqus_url = 'https://www.geekytidbits.com/rolling-snapshots-ec2/';
        (function () {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript';
            dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the
        <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
    </noscript>
    
</div>
        </div>
    </div>
    <div class="wrapper">
        <footer class="site-footer">
    &copy; 2019 Brady Holt
</footer>

    </div>
    <script>
        (function(i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function() {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
        ga('create', 'UA-19416043-2', 'auto');
        ga('send', 'pageview');
    </script>
    </body>
</html>
